{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "3886868221616079384"
    }
  },
  "definitions": {
    "_1.apimSkuInfo": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "allowedValues": [
            "BasicV2",
            "PremiumV2",
            "StandardV2"
          ]
        },
        "capacity": {
          "type": "int"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.functionValue": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "tag": {
          "type": "string"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.keyVaultSecretsInfo": {
      "type": "object",
      "properties": {
        "keyVaultName": {
          "type": "string"
        },
        "primaryKeySecretName": {
          "type": "string"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.openAIConfig": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "location": {
          "type": "string"
        },
        "suffix": {
          "type": "string"
        },
        "priority": {
          "type": "int"
        },
        "embedding": {
          "type": "object",
          "properties": {
            "capacity": {
              "type": "int"
            }
          }
        },
        "completion": {
          "type": "object",
          "properties": {
            "capacity": {
              "type": "int"
            },
            "sku": {
              "type": "string",
              "allowedValues": [
                "GlobalStandard",
                "Standard"
              ]
            }
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.openAIConfigs": {
      "type": "object",
      "properties": {
        "embeddingModel": {
          "type": "string"
        },
        "completionModel": {
          "type": "string"
        },
        "embeddingMaxTokens": {
          "type": "int"
        },
        "configs": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/_1.openAIConfig"
          }
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.openAiDeploymentInfo": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string"
        },
        "name": {
          "type": "string"
        },
        "host": {
          "type": "string"
        },
        "endpoint": {
          "type": "string"
        },
        "priority": {
          "type": "int",
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.openApiApimBackends": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "id": {
          "type": "string"
        },
        "priority": {
          "type": "int",
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.roleAssignmentInfo": {
      "type": "object",
      "properties": {
        "roleDefinitionId": {
          "type": "string"
        },
        "principalId": {
          "type": "string"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    }
  },
  "parameters": {
    "appName": {
      "type": "string"
    },
    "appNameSafe": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "myPublicIp": {
      "type": "string"
    },
    "docIntelligenceInstanceCount": {
      "type": "int"
    },
    "currentUserObjectId": {
      "type": "string"
    },
    "aiIndexName": {
      "type": "string",
      "defaultValue": "documentindex"
    },
    "apiManagementPublisherEmail": {
      "type": "string"
    },
    "apiManagementPublisherName": {
      "type": "string"
    },
    "serviceBusSku": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "functionValues": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/_1.functionValue"
      }
    },
    "apimSku": {
      "$ref": "#/definitions/_1.apimSkuInfo",
      "defaultValue": {
        "name": "StandardV2",
        "capacity": 1
      }
    },
    "funcAppPlanSku": {
      "type": "string",
      "allowedValues": [
        "EP1",
        "P0V3",
        "P1V3",
        "P2V3"
      ]
    },
    "openAiConfigs": {
      "$ref": "#/definitions/_1.openAIConfigs",
      "metadata": {
        "description": "OpenAI instances to deploy. Defaults to 2 across different regions."
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "aiSearch": "srch-",
      "aiServices": "aisa-",
      "aiVideoIndexer": "avi-",
      "machineLearningWorkspace": "mlw-",
      "openAIService": "oai-",
      "botService": "bot-",
      "computerVision": "cv-",
      "contentModerator": "cm-",
      "contentSafety": "cs-",
      "customVisionPrediction": "cstv-",
      "customVisionTraining": "cstvt-",
      "documentIntelligence": "di-",
      "faceApi": "face-",
      "healthInsights": "hi-",
      "immersiveReader": "ir-",
      "languageService": "lang-",
      "speechService": "spch-",
      "translator": "trsl-",
      "aiWorkspace": "aiw-",
      "analysisServicesServer": "as",
      "databricksWorkspace": "dbw-",
      "dataExplorerCluster": "dec",
      "dataExplorerClusterDatabase": "dedb",
      "dataFactory": "adf-",
      "digitalTwin": "dt-",
      "streamAnalytics": "asa-",
      "synapseAnalyticsWorkspaces": "synw",
      "synapseAnalyticsSQLDedicatedPool": "syndp",
      "synapseAnalyticsSparkPool": "synsp",
      "dataLakeStoreAccount": "dls",
      "eventHubsNamespace": "evhns-",
      "eventHub": "evh-",
      "eventGridDomain": "evgd-",
      "eventGridSubscriptions": "evgs-",
      "eventGridTopic": "evgt-",
      "eventGridSystemTopic": "egst-",
      "hdInsightHadoopCluster": "hadoop-",
      "hdInsightHBaseCluster": "hbase-",
      "hdInsightKafkaCluster": "kafka-",
      "hdInsightSparkCluster": "spark-",
      "hdInsightStormCluster": "storm-",
      "hdInsightMLServicesCluster": "mls-",
      "iotHub": "iot-",
      "provisioningServices": "provs-",
      "provisioningServicesCertificate": "pcert-",
      "powerBIEmbedded": "pbi-",
      "timeSeriesInsightsEnvironment": "tsi-",
      "appServiceEnvironment": "ase-",
      "appServicePlan": "asp-",
      "loadTesting": "lt-",
      "availabilitySet": "avail-",
      "arcEnabledServer": "arcs-",
      "arcEnabledKubernetesCluster": "arck",
      "batchAccounts": "ba-",
      "cloudService": "cld-",
      "communicationServices": "acs-",
      "diskEncryptionSet": "des",
      "functionApp": "func-",
      "gallery": "gal",
      "hostingEnvironment": "host-",
      "imageTemplate": "it-",
      "managedDiskOS": "osdisk",
      "managedDiskData": "disk",
      "notificationHubs": "ntf-",
      "notificationHubsNamespace": "ntfns-",
      "proximityPlacementGroup": "ppg-",
      "snapshot": "snap-",
      "staticWebApp": "stapp-",
      "virtualMachine": "vm",
      "virtualMachineScaleSet": "vmss-",
      "virtualMachineMaintenanceConfiguration": "mc-",
      "virtualMachineStorageAccount": "stvm",
      "webApp": "app-",
      "aksCluster": "aks-",
      "containerApp": "ca-",
      "containerAppsEnvironment": "cae-",
      "containerRegistry": "cr",
      "containerInstance": "ci",
      "serviceFabricCluster": "sf-",
      "serviceFabricManagedCluster": "sfmc-",
      "cosmosDBDatabase": "cosmos-",
      "cosmosDBApacheCassandra": "coscas-",
      "cosmosDBMongoDB": "cosmon-",
      "cosmosDBNoSQL": "cosno-",
      "cosmosDBTable": "costab-",
      "cosmosDBGremlin": "cosgrm-",
      "cosmosDBPostgreSQL": "cospos-",
      "cacheForRedis": "redis-",
      "sqlDatabaseServer": "sql-",
      "sqlDatabase": "sqldb-",
      "sqlElasticJobAgent": "sqlja-",
      "sqlElasticPool": "sqlep-",
      "mariaDBServer": "maria-",
      "mariaDBDatabase": "mariadb-",
      "mySQLDatabase": "mysql-",
      "postgreSQLDatabase": "psql-",
      "sqlServerStretchDatabase": "sqlstrdb-",
      "sqlManagedInstance": "sqlmi-",
      "appConfigurationStore": "appcs-",
      "mapsAccount": "map-",
      "signalR": "sigr",
      "webPubSub": "wps-",
      "managedGrafana": "amg-",
      "apiManagementService": "apim-",
      "integrationAccount": "ia-",
      "logicApps": "logic-",
      "serviceBusNamespace": "sbns-",
      "serviceBusQueue": "sbq-",
      "serviceBusTopic": "sbt-",
      "serviceBusTopicSubscription": "sbts-",
      "automationAccount": "aa-",
      "applicationInsights": "appi-",
      "monitorActionGroup": "ag-",
      "monitorDataCollectionRules": "dcr-",
      "blueprint": "bp-",
      "blueprintAssignment": "bpa-",
      "logAnalyticsWorkspace": "log-",
      "logAnalyticsQueryPacks": "pack-",
      "managementGroup": "mg-",
      "purviewInstance": "pview-",
      "resourceGroup": "rg-",
      "templateSpecsName": "ts-",
      "migrateProject": "migr-",
      "databaseMigrationService": "dms-",
      "recoveryServicesVault": "rsv-",
      "applicationGateway": "agw-",
      "applicationSecurityGroup": "asg-",
      "cdnProfile": "cdnp-",
      "cdnEndpoint": "cdne-",
      "connections": "con-",
      "dnsPrivateResolver": "dnspr-",
      "dnsPrivateResolverInboundEndpoint": "in-",
      "dnsPrivateResolverOutboundEndpoint": "out-",
      "firewall": "afw-",
      "firewallPolicy": "afwp-",
      "expressRouteCircuit": "erc-",
      "frontDoorProfile": "afd-",
      "frontDoorEndpoint": "fde-",
      "frontDoorFirewallPolicy": "fdfp-",
      "loadBalancerInternal": "lbi-",
      "loadBalancerExternal": "lbe-",
      "loadBalancerRule": "rule-",
      "localNetworkGateway": "lgw-",
      "natGateway": "ng-",
      "networkInterface": "nic-",
      "networkSecurityGroup": "nsg-",
      "networkSecurityGroupSecurityRules": "nsgsr-",
      "networkWatcher": "nw-",
      "privateLink": "pl-",
      "privateEndpoint": "pep-",
      "publicIPAddress": "pip-",
      "publicIPAddressPrefix": "ippre-",
      "routeFilter": "rf-",
      "routeServer": "rtserv-",
      "routeTable": "rt-",
      "serviceEndpointPolicy": "se-",
      "trafficManagerProfile": "traf-",
      "userDefinedRoute": "udr-",
      "virtualNetwork": "vnet-",
      "virtualNetworkGateway": "vgw-",
      "virtualNetworkManager": "vnm-",
      "virtualNetworkPeering": "peer-",
      "virtualNetworkSubnet": "snet-",
      "virtualWAN": "vwan-",
      "virtualWANHub": "vhub-",
      "bastion": "bas-",
      "keyVault": "kv-",
      "keyVaultManagedHSM": "kvmhsm-",
      "managedIdentity": "id-",
      "vpnGateway": "vpng-",
      "vpnConnection": "vcn-",
      "vpnSite": "vst-",
      "webApplicationFirewallPolicy": "waf",
      "webApplicationFirewallPolicyRuleGroup": "wafrg",
      "storSimple": "ssimp",
      "backupVault": "bvault-",
      "backupVaultPolicy": "bkpol-",
      "fileShare": "share-",
      "storageAccount": "st",
      "storageSyncService": "sss-",
      "virtualDesktopHostPool": "vdpool-",
      "virtualDesktopApplicationGroup": "vdag-",
      "virtualDesktopWorkspace": "vdws-",
      "virtualDesktopScalingPlan": "vdscaling-"
    },
    "abbrs": "[variables('$fxv#0')]",
    "appNameLc": "[toLower(parameters('appNameSafe'))]",
    "resourceGroupName": "[format('{0}{1}', variables('abbrs').resourceGroup, parameters('appName'))]",
    "serviceBusNs": "[format('{0}{1}-{2}', variables('abbrs').serviceBusNamespace, parameters('appName'), parameters('location'))]",
    "formStorageBase": "[format('{0}{1}{2}', variables('abbrs').storageAccount, variables('appNameLc'), parameters('location'))]",
    "formStorageAcct": "[if(greater(length(variables('formStorageBase')), 24), substring(variables('formStorageBase'), 0, 24), variables('formStorageBase'))]",
    "funcStorageBase": "[format('{0}{1}func{2}', variables('abbrs').storageAccount, variables('appNameLc'), parameters('location'))]",
    "funcStorageAcct": "[if(greater(length(variables('funcStorageBase')), 24), substring(variables('funcStorageBase'), 0, 24), variables('funcStorageBase'))]",
    "docIntelligence": "[format('{0}{1}-{2}', variables('abbrs').documentIntelligence, parameters('appName'), parameters('location'))]",
    "vnet": "[format('{0}{1}-{2}', variables('abbrs').virtualNetwork, parameters('appName'), parameters('location'))]",
    "subnet": "[format('{0}{1}-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "nsg": "[format('{0}{1}-{2}', variables('abbrs').networkSecurityGroup, parameters('appName'), parameters('location'))]",
    "funcsubnet": "[format('{0}{1}-func-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "apimsubnet": "[format('{0}{1}-apim-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "funcAppPlan": "[format('{0}{1}-{2}', variables('abbrs').appServicePlan, parameters('appName'), parameters('location'))]",
    "keyvaultNameBase": "[format('{0}{1}-{2}', variables('abbrs').keyVault, parameters('appName'), parameters('location'))]",
    "keyvaultName": "[if(greater(length(variables('keyvaultNameBase')), 24), substring(variables('keyvaultNameBase'), 0, 24), variables('keyvaultNameBase'))]",
    "aiSearchName": "[format('{0}{1}-demo-{2}', variables('abbrs').aiSearch, variables('appNameLc'), parameters('location'))]",
    "appInsightsName": "[format('{0}{1}-{2}', variables('abbrs').applicationInsights, parameters('appName'), parameters('location'))]",
    "logAnalyticsName": "[format('{0}{1}-{2}', variables('abbrs').logAnalyticsWorkspace, parameters('appName'), parameters('location'))]",
    "managedIdentityName": "[format('{0}{1}-{2}', variables('abbrs').managedIdentity, parameters('appName'), parameters('location'))]",
    "apiManagementName": "[format('{0}{1}-{2}', variables('abbrs').apiManagementService, parameters('appName'), parameters('location'))]",
    "cosmosDbName": "documentIndexing",
    "cosmosContainerName": "processTracker",
    "cosmosDbAccountName": "[toLower(format('{0}{1}-{2}', variables('abbrs').cosmosDBNoSQL, parameters('appName'), parameters('location')))]",
    "documentStorageContainer": "documents",
    "processResultsContainer": "processresults",
    "completedContainer": "completed",
    "customFieldQueueName": "customfieldqueue",
    "docQueueName": "docqueue",
    "moveQueueName": "movequeue",
    "toIndexQueueName": "toindexqueue"
  },
  "resources": {
    "rg": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]"
    },
    "managedIdentity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "managedIdentity",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('managedIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "15617797963517012510"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resource. Defaults to the location of the resource group."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "ID for the deployed Managed Identity resource."
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the deployed Managed Identity resource."
              },
              "value": "[parameters('name')]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID for the deployed Managed Identity resource."
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID for the deployed Managed Identity resource."
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "networkSecurityGroup": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networkSecurityGroup",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsg": {
            "value": "[variables('nsg')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "11516563349655266862"
            }
          },
          "parameters": {
            "nsg": {
              "type": "string"
            },
            "myPublicIp": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-02-01",
              "name": "[parameters('nsg')]",
              "location": "[parameters('location')]"
            },
            {
              "condition": "[not(equals(parameters('myPublicIp'), ''))]",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'AllowLocalIP')]",
              "properties": {
                "sourceAddressPrefix": "[parameters('myPublicIp')]",
                "destinationAddressPrefix": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "priority": 500,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'InternetToVnetInbound')]",
              "properties": {
                "sourceAddressPrefix": "Internet",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 505,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'trafficManagertoVnetOutbound')]",
              "properties": {
                "sourceAddressPrefix": "AzureTrafficManager",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 600,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'ApimManagementInbound')]",
              "properties": {
                "sourceAddressPrefix": "ApiManagement",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "3443",
                "priority": 510,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'LoadBalancerToVnetInbound')]",
              "properties": {
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "6390",
                "priority": 520,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToStorageOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "Storage",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 530,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToSQLOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "SQL",
                "sourcePortRange": "*",
                "destinationPortRange": "1443",
                "priority": 540,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToKeyVaultOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "AzureKeyVault",
                "sourcePortRange": "*",
                "destinationPortRange": "433",
                "priority": 550,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToAzureMonitorOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "AzureMonitor",
                "sourcePortRange": "*",
                "destinationPortRanges": [
                  "443",
                  "1886"
                ],
                "priority": 560,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "cosmosDb": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosDb",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "databaseName": {
            "value": "[variables('cosmosDbName')]"
          },
          "cosmosContainerName": {
            "value": "[variables('cosmosContainerName')]"
          },
          "cosmosDbAccountName": {
            "value": "[variables('cosmosDbAccountName')]"
          },
          "functionSubnetId": {
            "value": "[reference('networking').outputs.functionSubnetId.value]"
          },
          "apimSubnetId": {
            "value": "[reference('networking').outputs.apimSubnetId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('vnet')]"
          },
          "subnetName": {
            "value": "[variables('subnet')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "862983272309652473"
            }
          },
          "parameters": {
            "cosmosDbAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Cosmos DB account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Cosmos DB account"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the database to create"
              }
            },
            "cosmosContainerName": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Virtual Network"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet for the service endpoint"
              }
            },
            "myPublicIp": {
              "type": "string",
              "defaultValue": ""
            },
            "functionSubnetId": {
              "type": "string"
            },
            "apimSubnetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2021-10-15",
              "name": "[parameters('cosmosDbAccountName')]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "publicNetworkAccess": "Enabled",
                "isVirtualNetworkFilterEnabled": true,
                "virtualNetworkRules": [
                  {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
                    "ignoreMissingVNetServiceEndpoint": false
                  },
                  {
                    "id": "[parameters('functionSubnetId')]",
                    "ignoreMissingVNetServiceEndpoint": false
                  },
                  {
                    "id": "[parameters('apimSubnetId')]",
                    "ignoreMissingVNetServiceEndpoint": false
                  }
                ],
                "ipRules": "[if(not(empty(parameters('myPublicIp'))), createArray(createObject('ipAddressOrRange', parameters('myPublicIp'))), createArray())]",
                "enableFreeTier": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2021-10-15",
              "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2021-10-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), parameters('cosmosContainerName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosContainerName')]",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosDbAccountName": {
              "type": "string",
              "value": "[parameters('cosmosDbAccountName')]"
            },
            "cosmosDbDatabaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2021-10-15').documentEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "networking": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networking",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnet": {
            "value": "[variables('vnet')]"
          },
          "subnet": {
            "value": "[variables('subnet')]"
          },
          "nsg": {
            "value": "[variables('nsg')]"
          },
          "funcsubnet": {
            "value": "[variables('funcsubnet')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "apimsubnet": {
            "value": "[variables('apimsubnet')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "17808454297221527706"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "nsg": {
              "type": "string"
            },
            "vnet": {
              "type": "string"
            },
            "subnet": {
              "type": "string"
            },
            "funcsubnet": {
              "type": "string"
            },
            "apimsubnet": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-02-01",
              "name": "[parameters('vnet')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.10.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('funcsubnet')]",
                    "properties": {
                      "addressPrefix": "10.10.1.0/24",
                      "delegations": [
                        {
                          "name": "Microsoft.Web/serverFarms",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ],
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.Web",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      }
                    }
                  },
                  {
                    "name": "[parameters('apimsubnet')]",
                    "properties": {
                      "addressPrefix": "10.10.2.0/24",
                      "delegations": [
                        {
                          "name": "Microsoft.Web/serverFarms",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.EventHub",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.KeyVault",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.Sql",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ]
                    }
                  },
                  {
                    "name": "[parameters('subnet')]",
                    "properties": {
                      "addressPrefix": "10.10.0.0/24",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.Web",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "storageSubnetIds": {
              "type": "array",
              "value": [
                "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].id]",
                "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[2].id]"
              ]
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnet')]"
            },
            "functionSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].name]"
            },
            "functionSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].id]"
            },
            "apimSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[1].id]"
            }
          }
        }
      },
      "dependsOn": [
        "networkSecurityGroup",
        "rg"
      ]
    },
    "appInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appInsigts",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "logAnalyticsName": {
            "value": "[variables('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "functionNames": {
            "copy": [
              {
                "name": "value",
                "count": "[length(parameters('functionValues'))]",
                "input": "[parameters('functionValues')[copyIndex('value')].name]"
              }
            ]
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "9183324224270765682"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string"
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "functionNames": {
              "type": "array"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "variables": {
            "functionTags": "[reduce(parameters('functionNames'), createObject(), lambda('cur', 'functionName', union(lambdaVariables('cur'), createObject(format('{0}', format('hidden-link:/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Web/sites/{2}', subscription().id, resourceGroup().name, lambdaVariables('functionName'))), 'Resource'))))]"
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              },
              "tags": "[variables('functionTags')]",
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "storage": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storage",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "formStorageAcct": {
            "value": "[variables('formStorageAcct')]"
          },
          "funcStorageAcct": {
            "value": "[variables('funcStorageAcct')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetIds": {
            "value": "[reference('networking').outputs.storageSubnetIds.value]"
          },
          "completedContainer": {
            "value": "[variables('completedContainer')]"
          },
          "documentStorageContainer": {
            "value": "[variables('documentStorageContainer')]"
          },
          "processResultsContainer": {
            "value": "[variables('processResultsContainer')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16616409398590983899"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "formStorageAcct": {
              "type": "string"
            },
            "funcStorageAcct": {
              "type": "string"
            },
            "myPublicIp": {
              "type": "string"
            },
            "subnetIds": {
              "type": "array"
            },
            "documentStorageContainer": {
              "type": "string"
            },
            "processResultsContainer": {
              "type": "string"
            },
            "completedContainer": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('formStorageAcct')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "copy": [
                    {
                      "name": "virtualNetworkRules",
                      "count": "[length(parameters('subnetIds'))]",
                      "input": {
                        "id": "[parameters('subnetIds')[copyIndex('virtualNetworkRules')]]",
                        "action": "Allow"
                      }
                    }
                  ],
                  "defaultAction": "Deny",
                  "ipRules": "[if(not(empty(parameters('myPublicIp'))), createArray(createObject('value', parameters('myPublicIp'), 'action', 'Allow')), createArray())]"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('formStorageAcct'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('formStorageAcct'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('documentStorageContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('processResultsContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('completedContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('funcStorageAcct')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2"
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('formStorageAcct'))]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "docIntelligenceService": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "docintelligence",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "docIntelligenceName": {
            "value": "[variables('docIntelligence')]"
          },
          "docIntelligenceInstanceCount": {
            "value": "[parameters('docIntelligenceInstanceCount')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "7219224866739419743"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "docIntelligenceName": {
              "type": "string"
            },
            "docIntelligenceInstanceCount": {
              "type": "int",
              "defaultValue": 1
            }
          },
          "resources": [
            {
              "copy": {
                "name": "docIntelligenceAccount",
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]"
              },
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-10-01-preview",
              "name": "[format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()], 2, '0'))]",
              "location": "[parameters('location')]",
              "kind": "FormRecognizer",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "Enabled"
              },
              "identity": {
                "type": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "docIntelligenceAccountName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[0], 2, '0'))), '2023-10-01-preview').endpoint]"
            },
            "docIntelligenceAccountIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[resourceId('Microsoft.CognitiveServices/accounts', format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0')))]"
              }
            },
            "docIntelligencePrincipalIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0'))), '2023-10-01-preview', 'full').identity.principalId]"
              }
            },
            "docIntellEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[0], 2, '0'))), '2023-10-01-preview').endpoint]"
            },
            "docIntellEndpoints": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}_{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0'))), '2023-10-01-preview').endpoint]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "servicebus": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "serviceBus",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "serviceBusNs": {
            "value": "[variables('serviceBusNs')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "docQueueName": {
            "value": "[variables('docQueueName')]"
          },
          "moveQueueName": {
            "value": "[variables('moveQueueName')]"
          },
          "toIndexQueueName": {
            "value": "[variables('toIndexQueueName')]"
          },
          "customFieldQueueName": {
            "value": "[variables('customFieldQueueName')]"
          },
          "subnetName": {
            "value": "[variables('funcsubnet')]"
          },
          "vnetName": {
            "value": "[variables('vnet')]"
          },
          "serviceBusSku": {
            "value": "[parameters('serviceBusSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "7226094278711892524"
            }
          },
          "parameters": {
            "serviceBusNs": {
              "type": "string"
            },
            "docQueueName": {
              "type": "string"
            },
            "moveQueueName": {
              "type": "string"
            },
            "toIndexQueueName": {
              "type": "string"
            },
            "customFieldQueueName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "serviceBusSku": {
              "type": "string",
              "defaultValue": "Standard"
            },
            "vnetName": {
              "type": "string",
              "defaultValue": ""
            },
            "subnetName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "enablePartitioning": "[not(equals(parameters('serviceBusSku'), 'Premium'))]",
            "includeNetworking": "[equals(parameters('serviceBusSku'), 'Premium')]"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[parameters('serviceBusNs')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('serviceBusSku')]"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('docQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('moveQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('toIndexQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('customFieldQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "condition": "[variables('includeNetworking')]",
              "type": "Microsoft.ServiceBus/namespaces/networkRuleSets",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), 'default')]",
              "properties": {
                "defaultAction": "Deny",
                "trustedServiceAccessEnabled": true,
                "virtualNetworkRules": [
                  {
                    "subnet": {
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                    },
                    "ignoreMissingVnetServiceEndpoint": false
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
            },
            "serviceBusFullyQualifiedNamespace": {
              "type": "string",
              "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNs'))]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "keyvault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyvault",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyvaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "14572934140426015286"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enabledForDeployment": true,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": true,
                "enableSoftDelete": true,
                "enablePurgeProtection": true,
                "enableRbacAuthorization": true
              }
            }
          ],
          "outputs": {
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "functions": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functions",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "funcAppPlan": {
            "value": "[variables('funcAppPlan')]"
          },
          "functionValues": {
            "value": "[parameters('functionValues')]"
          },
          "customFieldQueueName": {
            "value": "[variables('customFieldQueueName')]"
          },
          "formStorageAcctName": {
            "value": "[variables('formStorageAcct')]"
          },
          "functionStorageAcctName": {
            "value": "[variables('funcStorageAcct')]"
          },
          "moveQueueName": {
            "value": "[variables('moveQueueName')]"
          },
          "serviceBusNs": {
            "value": "[variables('serviceBusNs')]"
          },
          "functionSubnetId": {
            "value": "[reference('networking').outputs.functionSubnetId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "docQueueName": {
            "value": "[variables('docQueueName')]"
          },
          "completedContainer": {
            "value": "[variables('completedContainer')]"
          },
          "documentStorageContainer": {
            "value": "[variables('documentStorageContainer')]"
          },
          "processResultsContainer": {
            "value": "[variables('processResultsContainer')]"
          },
          "toIndexQueueName": {
            "value": "[variables('toIndexQueueName')]"
          },
          "aiSearchEndpoint": {
            "value": "[reference('aiSearch').outputs.aiSearchEndpoint.value]"
          },
          "openAiEmbeddingModel": {
            "value": "[parameters('openAiConfigs').embeddingModel]"
          },
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "aiIndexName": {
            "value": "[parameters('aiIndexName')]"
          },
          "managedIdentityId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          },
          "managedIdentityClientId": {
            "value": "[reference('managedIdentity').outputs.clientId.value]"
          },
          "azureOpenAiEmbeddingMaxTokens": {
            "value": "[parameters('openAiConfigs').embeddingMaxTokens]"
          },
          "openAiEndpoint": {
            "value": "[reference('apiManagement').outputs.gatewayUrl.value]"
          },
          "openAiChatModel": {
            "value": "[parameters('openAiConfigs').completionModel]"
          },
          "cosmosDbName": {
            "value": "[variables('cosmosDbName')]"
          },
          "cosmosContainerName": {
            "value": "[variables('cosmosContainerName')]"
          },
          "funcAppPlanSku": {
            "value": "[parameters('funcAppPlanSku')]"
          },
          "cosmosDbEndpoint": {
            "value": "[reference('cosmosDb').outputs.cosmosDbEndpoint.value]"
          },
          "serviceBusFullyQualifiedNamespace": {
            "value": "[reference('servicebus').outputs.serviceBusFullyQualifiedNamespace.value]"
          },
          "documentIntelligenceEndpoint": {
            "value": "[reference('docIntelligenceService').outputs.docIntellEndpoint.value]"
          },
          "documentIntelligenceEndpoints": {
            "value": "[string(reference('docIntelligenceService').outputs.docIntellEndpoints.value)]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "3580256751146216174"
            }
          },
          "definitions": {
            "_1.apimSkuInfo": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "BasicV2",
                    "PremiumV2",
                    "StandardV2"
                  ]
                },
                "capacity": {
                  "type": "int"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.functionValue": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.keyVaultSecretsInfo": {
              "type": "object",
              "properties": {
                "keyVaultName": {
                  "type": "string"
                },
                "primaryKeySecretName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "suffix": {
                  "type": "string"
                },
                "priority": {
                  "type": "int"
                },
                "embedding": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    }
                  }
                },
                "completion": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    },
                    "sku": {
                      "type": "string",
                      "allowedValues": [
                        "GlobalStandard",
                        "Standard"
                      ]
                    }
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfigs": {
              "type": "object",
              "properties": {
                "embeddingModel": {
                  "type": "string"
                },
                "completionModel": {
                  "type": "string"
                },
                "embeddingMaxTokens": {
                  "type": "int"
                },
                "configs": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/_1.openAIConfig"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAiDeploymentInfo": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "host": {
                  "type": "string"
                },
                "endpoint": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openApiApimBackends": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "id": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.roleAssignmentInfo": {
              "type": "object",
              "properties": {
                "roleDefinitionId": {
                  "type": "string"
                },
                "principalId": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            }
          },
          "parameters": {
            "funcAppPlan": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "functionValues": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.functionValue"
              }
            },
            "functionSubnetId": {
              "type": "string"
            },
            "functionStorageAcctName": {
              "type": "string"
            },
            "moveQueueName": {
              "type": "string"
            },
            "serviceBusNs": {
              "type": "string"
            },
            "formStorageAcctName": {
              "type": "string"
            },
            "customFieldQueueName": {
              "type": "string"
            },
            "docQueueName": {
              "type": "string"
            },
            "toIndexQueueName": {
              "type": "string"
            },
            "openAiEmbeddingModel": {
              "type": "string"
            },
            "aiSearchEndpoint": {
              "type": "string"
            },
            "openAiEndpoint": {
              "type": "string"
            },
            "cosmosDbEndpoint": {
              "type": "string"
            },
            "serviceBusFullyQualifiedNamespace": {
              "type": "string"
            },
            "documentIntelligenceEndpoint": {
              "type": "string"
            },
            "documentIntelligenceEndpoints": {
              "type": "string"
            },
            "azureOpenAiEmbeddingMaxTokens": {
              "type": "int",
              "defaultValue": 8091
            },
            "managedIdentityId": {
              "type": "string"
            },
            "managedIdentityClientId": {
              "type": "string"
            },
            "documentStorageContainer": {
              "type": "string"
            },
            "processResultsContainer": {
              "type": "string"
            },
            "completedContainer": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "aiIndexName": {
              "type": "string"
            },
            "openAiChatModel": {
              "type": "string"
            },
            "cosmosDbName": {
              "type": "string"
            },
            "cosmosContainerName": {
              "type": "string"
            },
            "funcAppPlanSku": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": {
              "AZURE_AISEARCH_ENDPOINT": "AZURE_AISEARCH_ENDPOINT",
              "AZURE_AISEARCH_INCLUDE_GENERAL_INDEX": "AZURE_AISEARCH_INCLUDE_GENERAL_INDEX",
              "AZURE_AISEARCH_INDEX_NAME": "AZURE_AISEARCH_INDEX_NAME",
              "AZURE_OPENAI_CHAT_DEPLOYMENT": "AZURE_OPENAI_CHAT_DEPLOYMENT",
              "AZURE_OPENAI_CHAT_MODEL": "AZURE_OPENAI_CHAT_MODEL",
              "AZURE_OPENAI_EMBEDDING_DEPLOYMENT": "AZURE_OPENAI_EMBEDDING_DEPLOYMENT",
              "AZURE_OPENAI_EMBEDDING_MAXTOKENS": "AZURE_OPENAI_EMBEDDING_MAXTOKENS",
              "AZURE_OPENAI_EMBEDDING_MODEL": "AZURE_OPENAI_EMBEDDING_MODEL",
              "AZURE_OPENAI_ENDPOINT": "AZURE_OPENAI_ENDPOINT",
              "COSMOS_ACCOUNT_ENDPOINT": "COSMOS_ACCOUNT_ENDPOINT",
              "COSMOS_DB_NAME": "COSMOS_DB_NAME",
              "COSMOS_CONTAINER_NAME": "COSMOS_CONTAINER_NAME",
              "DOCUMENT_INTELLIGENCE_ENDPOINT": "DOCUMENT_INTELLIGENCE_ENDPOINT",
              "DOCUMENT_INTELLIGENCE_ENDPOINTS": "DOCUMENT_INTELLIGENCE_ENDPOINTS",
              "DOCUMENT_INTELLIGENCE_MODEL_NAME": "DOCUMENT_INTELLIGENCE_MODEL_NAME",
              "SERVICEBUS_CONNECTION": "SERVICEBUS_CONNECTION",
              "SERVICEBUS_CUSTOMFIELD_QUEUE_NAME": "SERVICEBUS_CUSTOMFIELD_QUEUE_NAME",
              "SERVICEBUS_DOC_QUEUE_NAME": "SERVICEBUS_DOC_QUEUE_NAME",
              "SERVICEBUS_MOVE_QUEUE_NAME": "SERVICEBUS_MOVE_QUEUE_NAME",
              "SERVICEBUS_NAMESPACE_NAME": "SERVICEBUS_NAMESPACE_NAME",
              "SERVICEBUS_TOINDEX_QUEUE_NAME": "SERVICEBUS_TOINDEX_QUEUE_NAME",
              "STORAGE_ACCOUNT_NAME": "STORAGE_ACCOUNT_NAME",
              "STORAGE_COMPLETED_CONTAINER_NAME": "STORAGE_COMPLETED_CONTAINER_NAME",
              "STORAGE_PROCESS_RESULTS_CONTAINER_NAME": "STORAGE_PROCESS_RESULTS_CONTAINER_NAME",
              "STORAGE_SOURCE_CONTAINER_NAME": "STORAGE_SOURCE_CONTAINER_NAME"
            },
            "configKeys": "[variables('$fxv#0')]"
          },
          "resources": {
            "funcStorageAcct": {
              "existing": true,
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-04-01",
              "name": "[parameters('functionStorageAcctName')]"
            },
            "appInsights": {
              "existing": true,
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]"
            },
            "functionAppPlan": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[parameters('funcAppPlan')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "funcAppPlan": {
                    "value": "[parameters('funcAppPlan')]"
                  },
                  "funcAppPlanSku": {
                    "value": "[parameters('funcAppPlanSku')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "1272940589322964629"
                    }
                  },
                  "parameters": {
                    "funcAppPlan": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "funcAppPlanSku": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Web/serverfarms",
                      "apiVersion": "2021-01-01",
                      "name": "[parameters('funcAppPlan')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('funcAppPlanSku')]",
                        "capacity": 4
                      },
                      "properties": {
                        "reserved": false
                      }
                    }
                  ],
                  "outputs": {
                    "functionAppPlanId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Web/serverfarms', parameters('funcAppPlan'))]"
                    }
                  }
                }
              }
            },
            "function": {
              "copy": {
                "name": "function",
                "count": "[length(parameters('functionValues'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[parameters('functionValues')[copyIndex()].name]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "functionName": {
                    "value": "[parameters('functionValues')[copyIndex()].name]"
                  },
                  "functionTag": {
                    "value": "[parameters('functionValues')[copyIndex()].tag]"
                  },
                  "functionSubnetId": {
                    "value": "[parameters('functionSubnetId')]"
                  },
                  "managedIdentityId": {
                    "value": "[parameters('managedIdentityId')]"
                  },
                  "funcAppPlanId": {
                    "value": "[reference('functionAppPlan').outputs.functionAppPlanId.value]"
                  },
                  "sharedConfiguration": {
                    "value": [
                      {
                        "name": "[variables('configKeys').COSMOS_ACCOUNT_ENDPOINT]",
                        "value": "[parameters('cosmosDbEndpoint')]"
                      },
                      {
                        "name": "[variables('configKeys').COSMOS_DB_NAME]",
                        "value": "[parameters('cosmosDbName')]"
                      },
                      {
                        "name": "[variables('configKeys').COSMOS_CONTAINER_NAME]",
                        "value": "[parameters('cosmosContainerName')]"
                      },
                      {
                        "name": "[variables('configKeys').STORAGE_ACCOUNT_NAME]",
                        "value": "[parameters('formStorageAcctName')]"
                      },
                      {
                        "name": "[variables('configKeys').STORAGE_SOURCE_CONTAINER_NAME]",
                        "value": "[parameters('documentStorageContainer')]"
                      },
                      {
                        "name": "[variables('configKeys').STORAGE_PROCESS_RESULTS_CONTAINER_NAME]",
                        "value": "[parameters('processResultsContainer')]"
                      },
                      {
                        "name": "[variables('configKeys').STORAGE_COMPLETED_CONTAINER_NAME]",
                        "value": "[parameters('completedContainer')]"
                      },
                      {
                        "name": "[variables('configKeys').SERVICEBUS_NAMESPACE_NAME]",
                        "value": "[parameters('serviceBusNs')]"
                      },
                      {
                        "name": "[variables('configKeys').SERVICEBUS_DOC_QUEUE_NAME]",
                        "value": "[parameters('docQueueName')]"
                      },
                      {
                        "name": "[variables('configKeys').SERVICEBUS_CUSTOMFIELD_QUEUE_NAME]",
                        "value": "[parameters('customFieldQueueName')]"
                      },
                      {
                        "name": "[variables('configKeys').SERVICEBUS_TOINDEX_QUEUE_NAME]",
                        "value": "[parameters('toIndexQueueName')]"
                      },
                      {
                        "name": "[variables('configKeys').SERVICEBUS_MOVE_QUEUE_NAME]",
                        "value": "[parameters('moveQueueName')]"
                      },
                      {
                        "name": "[format('{0}__fullyQualifiedNamespace', variables('configKeys').SERVICEBUS_CONNECTION)]",
                        "value": "[parameters('serviceBusFullyQualifiedNamespace')]"
                      },
                      {
                        "name": "[format('{0}__credential', variables('configKeys').SERVICEBUS_CONNECTION)]",
                        "value": "ManagedIdentity"
                      },
                      {
                        "name": "[format('{0}__clientId', variables('configKeys').SERVICEBUS_CONNECTION)]",
                        "value": "[parameters('managedIdentityClientId')]"
                      },
                      {
                        "name": "AzureWebJobsStorage__accountName",
                        "value": "[parameters('functionStorageAcctName')]"
                      },
                      {
                        "name": "AzureWebJobsStorage__blobServiceUri",
                        "value": "[format('https://{0}.blob.{1}', parameters('functionStorageAcctName'), environment().suffixes.storage)]"
                      },
                      {
                        "name": "AzureWebJobsStorage__queueServiceUri",
                        "value": "[format('https://{0}.queue.{1}', parameters('functionStorageAcctName'), environment().suffixes.storage)]"
                      },
                      {
                        "name": "AzureWebJobsStorage__tableServiceUri",
                        "value": "[format('https://{0}.table.{1}', parameters('functionStorageAcctName'), environment().suffixes.storage)]"
                      },
                      {
                        "name": "AzureWebJobsStorage__credential",
                        "value": "ManagedIdentity"
                      },
                      {
                        "name": "AzureWebJobsStorage__clientId",
                        "value": "[parameters('managedIdentityClientId')]"
                      },
                      {
                        "name": "FUNCTIONS_EXTENSION_VERSION",
                        "value": "~4"
                      },
                      {
                        "name": "FUNCTIONS_WORKER_RUNTIME",
                        "value": "dotnet-isolated"
                      },
                      {
                        "name": "WEBSITE_RUN_FROM_PACKAGE",
                        "value": "1"
                      },
                      {
                        "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                        "value": "[reference('appInsights').ConnectionString]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_AISEARCH_ENDPOINT]",
                        "value": "[parameters('aiSearchEndpoint')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_AISEARCH_INDEX_NAME]",
                        "value": "[parameters('aiIndexName')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_ENDPOINT]",
                        "value": "[parameters('openAiEndpoint')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_EMBEDDING_MODEL]",
                        "value": "[parameters('openAiEmbeddingModel')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_EMBEDDING_DEPLOYMENT]",
                        "value": "[parameters('openAiEmbeddingModel')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_EMBEDDING_MAXTOKENS]",
                        "value": "[string(parameters('azureOpenAiEmbeddingMaxTokens'))]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_CHAT_MODEL]",
                        "value": "[parameters('openAiChatModel')]"
                      },
                      {
                        "name": "[variables('configKeys').AZURE_OPENAI_CHAT_DEPLOYMENT]",
                        "value": "[parameters('openAiChatModel')]"
                      },
                      {
                        "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_MODEL_NAME]",
                        "value": "prebuilt-layout"
                      },
                      {
                        "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_ENDPOINT]",
                        "value": "[parameters('documentIntelligenceEndpoint')]"
                      },
                      {
                        "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_ENDPOINTS]",
                        "value": "[parameters('documentIntelligenceEndpoints')]"
                      }
                    ]
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "85593371932089243"
                    }
                  },
                  "parameters": {
                    "funcAppPlanId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "functionName": {
                      "type": "string"
                    },
                    "functionTag": {
                      "type": "string"
                    },
                    "functionSubnetId": {
                      "type": "string"
                    },
                    "managedIdentityId": {
                      "type": "string"
                    },
                    "sharedConfiguration": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Web/sites",
                      "apiVersion": "2021-01-01",
                      "name": "[parameters('functionName')]",
                      "location": "[parameters('location')]",
                      "kind": "functionapp",
                      "identity": {
                        "type": "SystemAssigned, UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('managedIdentityId'))]": {}
                        }
                      },
                      "tags": {
                        "azd-service-name": "[parameters('functionTag')]"
                      },
                      "properties": {
                        "virtualNetworkSubnetId": "[parameters('functionSubnetId')]",
                        "serverFarmId": "[parameters('funcAppPlanId')]",
                        "keyVaultReferenceIdentity": "[parameters('managedIdentityId')]",
                        "siteConfig": {
                          "cors": {
                            "allowedOrigins": [
                              "https://portal.azure.com",
                              "https://ms.portal.azure.com"
                            ]
                          },
                          "use32BitWorkerProcess": false,
                          "netFrameworkVersion": "v8.0",
                          "remoteDebuggingEnabled": false,
                          "appSettings": "[parameters('sharedConfiguration')]"
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "systemAssignedIdentity": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Web/sites', parameters('functionName')), '2021-01-01', 'full').identity.principalId]"
                    }
                  }
                }
              },
              "dependsOn": [
                "appInsights",
                "functionAppPlan"
              ]
            }
          },
          "outputs": {
            "systemAssignedIdentities": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, length(parameters('functionValues'))))]",
                "input": "[reference(format('function[{0}]', range(0, length(parameters('functionValues')))[copyIndex()])).outputs.systemAssignedIdentity.value]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "aiSearch",
        "apiManagement",
        "cosmosDb",
        "docIntelligenceService",
        "managedIdentity",
        "networking",
        "rg",
        "servicebus",
        "storage"
      ]
    },
    "roleAssigments": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "roleAssigments",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "docIntelligencePrincipalIds": {
            "value": "[reference('docIntelligenceService').outputs.docIntelligencePrincipalIds.value]"
          },
          "userAssignedManagedIdentityPrincipalId": {
            "value": "[reference('managedIdentity').outputs.principalId.value]"
          },
          "currentUserObjectId": {
            "value": "[parameters('currentUserObjectId')]"
          },
          "functionPrincipalIds": {
            "value": "[reference('functions').outputs.systemAssignedIdentities.value]"
          },
          "apimSystemAssignedIdentityPrincipalId": {
            "value": "[reference('apiManagement').outputs.identity.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "9316021314481291032"
            }
          },
          "parameters": {
            "docIntelligencePrincipalIds": {
              "type": "array"
            },
            "functionPrincipalIds": {
              "type": "array"
            },
            "userAssignedManagedIdentityPrincipalId": {
              "type": "string"
            },
            "currentUserObjectId": {
              "type": "string"
            },
            "apimSystemAssignedIdentityPrincipalId": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": {
              "contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
              "owner": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
              "reader": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
              "rbacAdministrator": "f58310d9-a9f6-439a-9e8d-f62e7b41a168",
              "userAccessAdministrator": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
              "keyVaultAdministrator": "00482a5a-887f-4fb3-b363-3b7fe8e74483",
              "keyVaultContributor": "f25e0fa2-a7c8-4377-a976-54943a77a395",
              "keyVaultSecretsOfficer": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6",
              "acrPull": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
              "acrPush": "8311e382-0749-4cb8-b61a-304f252e45ec",
              "serviceBusDataOwner": "090c5cfd-751d-490a-894a-3ce6f1109419",
              "serviceBusDataReceiver": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0",
              "serviceBusDataSender": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
              "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "storageBlobDataOwner": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
              "storageBlobDataReader": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "storageQueueDataContributor": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
              "storageQueueDataReader": "19e7f393-937e-4f77-808e-94535e297925",
              "storageTableDataContributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
              "storageTableDataReader": "76199698-9eea-4c19-bc75-cec21354c6b6",
              "cognitiveServicesUser": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
              "cosmosDbOperator": "230815da-be43-4aae-9cb4-875f7bd000aa",
              "cosmosDbBuiltInDataContributor": "5bd9cd88-fe45-4216-938b-f97437e15450",
              "searchServiceContributor": "de139f84-1756-47ae-9be6-808fbbe84772"
            },
            "principalIds": "[if(not(empty(parameters('currentUserObjectId'))), concat(parameters('functionPrincipalIds'), createArray(parameters('currentUserObjectId'), parameters('userAssignedManagedIdentityPrincipalId'))), concat(parameters('functionPrincipalIds'), createArray(parameters('userAssignedManagedIdentityPrincipalId'))))]",
            "deploymentEntropy": "3F2504E0-4F89-11D3-9A0C-0305E82C3302",
            "roles": "[variables('$fxv#0')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(parameters('apimSystemAssignedIdentityPrincipalId'), resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser)]",
                "principalId": "[parameters('apimSystemAssignedIdentityPrincipalId')]"
              }
            },
            {
              "copy": {
                "name": "docIntelligenceBlobDataReader",
                "count": "[length(parameters('docIntelligencePrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(parameters('docIntelligencePrincipalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataReader), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataReader)]",
                "principalId": "[parameters('docIntelligencePrincipalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityBlobDataContrib",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityBlobDataOwner",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataOwner), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataOwner)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityServiceBusDataOwner",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').serviceBusDataOwner), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').serviceBusDataOwner)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityStorageQueueDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityStorageTableDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityKeyVaultSecretUser",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityCosmosDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbBuiltInDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbBuiltInDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentitySearchServiceContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchServiceContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchServiceContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityCognitiveServicesUser",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            }
          ],
          "outputs": {
            "principalIds": {
              "type": "array",
              "value": "[variables('principalIds')]"
            }
          }
        }
      },
      "dependsOn": [
        "apiManagement",
        "docIntelligenceService",
        "functions",
        "managedIdentity",
        "rg"
      ]
    },
    "aiSearch": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "aiSearch",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": {
            "value": "[variables('aiSearchName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "12164776842200732067"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('aiSearchName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "basic"
              }
            }
          ],
          "outputs": {
            "aiSearchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', parameters('aiSearchName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "apiManagement": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "apiManagement",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('apiManagementName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "apiManagementIdentityId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          },
          "publisherEmail": {
            "value": "[parameters('apiManagementPublisherEmail')]"
          },
          "publisherName": {
            "value": "[parameters('apiManagementPublisherName')]"
          },
          "subnetId": {
            "value": "[reference('networking').outputs.apimSubnetId.value]"
          },
          "openAIDeployments": {
            "value": "[reference('openAi').outputs.openAIDeployments.value]"
          },
          "sku": {
            "value": "[parameters('apimSku')]"
          },
          "tags": {
            "value": {
              "CreatedBy": "[parameters('currentUserObjectId')]"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "11607614713647376085"
            }
          },
          "definitions": {
            "_1.apimSkuInfo": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "BasicV2",
                    "PremiumV2",
                    "StandardV2"
                  ]
                },
                "capacity": {
                  "type": "int"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.functionValue": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.keyVaultSecretsInfo": {
              "type": "object",
              "properties": {
                "keyVaultName": {
                  "type": "string"
                },
                "primaryKeySecretName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "suffix": {
                  "type": "string"
                },
                "priority": {
                  "type": "int"
                },
                "embedding": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    }
                  }
                },
                "completion": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    },
                    "sku": {
                      "type": "string",
                      "allowedValues": [
                        "GlobalStandard",
                        "Standard"
                      ]
                    }
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfigs": {
              "type": "object",
              "properties": {
                "embeddingModel": {
                  "type": "string"
                },
                "completionModel": {
                  "type": "string"
                },
                "embeddingMaxTokens": {
                  "type": "int"
                },
                "configs": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/_1.openAIConfig"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAiDeploymentInfo": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "host": {
                  "type": "string"
                },
                "endpoint": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openApiApimBackends": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "id": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.roleAssignmentInfo": {
              "type": "object",
              "properties": {
                "roleDefinitionId": {
                  "type": "string"
                },
                "principalId": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resource. Defaults to the location of the resource group."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resource."
              }
            },
            "apiManagementIdentityId": {
              "type": "string",
              "metadata": {
                "description": "ID for the Managed Identity associated with the API Management resource."
              }
            },
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "ID for the subnet to deploy the API Management resource."
              }
            },
            "publisherEmail": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Email address of the owner for the API Management resource."
              }
            },
            "publisherName": {
              "type": "string",
              "minLength": 1,
              "metadata": {
                "description": "Name of the owner for the API Management resource."
              }
            },
            "sku": {
              "$ref": "#/definitions/_1.apimSkuInfo",
              "defaultValue": {
                "name": "StandardV2",
                "capacity": 1
              },
              "metadata": {
                "description": "API Management SKU. Defaults to StandardV2, capacity 1."
              }
            },
            "openAIDeployments": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.openAiDeploymentInfo"
              }
            }
          },
          "resources": {
            "apiManagement": {
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2023-05-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": "[parameters('sku')]",
              "identity": {
                "type": "SystemAssigned, UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('apiManagementIdentityId'))]": {}
                }
              },
              "properties": {
                "publisherEmail": "[parameters('publisherEmail')]",
                "publisherName": "[parameters('publisherName')]",
                "virtualNetworkType": "External",
                "virtualNetworkConfiguration": {
                  "subnetResourceId": "[parameters('subnetId')]"
                }
              }
            },
            "openAIApiBackend": {
              "copy": {
                "name": "openAIApiBackend",
                "count": "[length(parameters('openAIDeployments'))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('backend-openai-{0}', parameters('openAIDeployments')[copyIndex()].name)]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "[format('OPENAI{0}', toUpper(parameters('openAIDeployments')[copyIndex()].name))]"
                  },
                  "apiManagementName": {
                    "value": "[parameters('name')]"
                  },
                  "url": {
                    "value": "[format('{0}openai', parameters('openAIDeployments')[copyIndex()].host)]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "6090482308475780747"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Backend."
                      }
                    },
                    "apiManagementName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the API Management associated with the Backend."
                      }
                    },
                    "url": {
                      "type": "string",
                      "metadata": {
                        "description": "URL of the Backend."
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/backends",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('apiManagementName'), parameters('name'))]",
                      "properties": {
                        "protocol": "http",
                        "url": "[parameters('url')]",
                        "circuitBreaker": {
                          "rules": [
                            {
                              "failureCondition": {
                                "count": 3,
                                "errorReasons": [
                                  "Server errors"
                                ],
                                "interval": "PT10S",
                                "statusCodeRanges": [
                                  {
                                    "min": 400,
                                    "max": 599
                                  }
                                ]
                              },
                              "name": "[format('{0}-BreakerRule', parameters('name'))]",
                              "tripDuration": "PT10S",
                              "acceptRetryAfter": true
                            }
                          ]
                        }
                      }
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "metadata": {
                        "description": "ID for the deployed API Management Backend resource."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apiManagementName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the deployed API Management Backend resource."
                      },
                      "value": "[parameters('name')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "apiManagement"
              ]
            }
          },
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "ID for the deployed API Management resource."
              },
              "value": "[resourceId('Microsoft.ApiManagement/service', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the deployed API Management resource."
              },
              "value": "[parameters('name')]"
            },
            "gatewayUrl": {
              "type": "string",
              "metadata": {
                "description": "Gateway URL for the deployed API Management resource."
              },
              "value": "[reference('apiManagement').gatewayUrl]"
            },
            "identity": {
              "type": "string",
              "value": "[reference('apiManagement', '2023-05-01-preview', 'full').identity.principalId]"
            },
            "openAIApiBackends": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.openApiApimBackends"
              },
              "copy": {
                "count": "[length(parameters('openAIDeployments'))]",
                "input": {
                  "name": "[format('backend-openai-{0}', parameters('openAIDeployments')[copyIndex()].name)]",
                  "id": "[reference(format('openAIApiBackend[{0}]', copyIndex())).outputs.id.value]",
                  "priority": "[tryGet(parameters('openAIDeployments')[copyIndex()], 'priority')]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "managedIdentity",
        "networking",
        "openAi",
        "rg"
      ]
    },
    "aoiManamgentSettings": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "apiManagementSettings",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "apiManagementName": {
            "value": "[reference('apiManagement').outputs.name.value]"
          },
          "openApiApimBackends": {
            "value": "[reference('apiManagement').outputs.openAIApiBackends.value]"
          },
          "appInsightsName": {
            "value": "[reference('appInsights').outputs.name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16252111594111255700"
            }
          },
          "definitions": {
            "_1.apimSkuInfo": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "BasicV2",
                    "PremiumV2",
                    "StandardV2"
                  ]
                },
                "capacity": {
                  "type": "int"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.functionValue": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.keyVaultSecretsInfo": {
              "type": "object",
              "properties": {
                "keyVaultName": {
                  "type": "string"
                },
                "primaryKeySecretName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "suffix": {
                  "type": "string"
                },
                "priority": {
                  "type": "int"
                },
                "embedding": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    }
                  }
                },
                "completion": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    },
                    "sku": {
                      "type": "string",
                      "allowedValues": [
                        "GlobalStandard",
                        "Standard"
                      ]
                    }
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfigs": {
              "type": "object",
              "properties": {
                "embeddingModel": {
                  "type": "string"
                },
                "completionModel": {
                  "type": "string"
                },
                "embeddingMaxTokens": {
                  "type": "int"
                },
                "configs": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/_1.openAIConfig"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAiDeploymentInfo": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "host": {
                  "type": "string"
                },
                "endpoint": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openApiApimBackends": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "id": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.roleAssignmentInfo": {
              "type": "object",
              "properties": {
                "roleDefinitionId": {
                  "type": "string"
                },
                "principalId": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            }
          },
          "parameters": {
            "apiManagementName": {
              "type": "string"
            },
            "appInsightsName": {
              "type": "string"
            },
            "openApiApimBackends": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.openApiApimBackends"
              }
            }
          },
          "variables": {
            "loadBalancerName": "openai-loadbalancer"
          },
          "resources": {
            "apiManagement": {
              "existing": true,
              "type": "Microsoft.ApiManagement/service",
              "apiVersion": "2023-05-01-preview",
              "name": "[parameters('apiManagementName')]"
            },
            "openAIApi": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-api-openai', parameters('apiManagementName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "name": {
                    "value": "openai"
                  },
                  "loadBalancerName": {
                    "value": "[reference('apimLoadBalancing').outputs.name.value]"
                  },
                  "apiManagementName": {
                    "value": "[parameters('apiManagementName')]"
                  },
                  "path": {
                    "value": "/openai"
                  },
                  "format": {
                    "value": "openapi-link"
                  },
                  "displayName": {
                    "value": "OpenAI"
                  },
                  "value": {
                    "value": "https://raw.githubusercontent.com/Azure/azure-rest-api-specs/refs/heads/main/specification/cognitiveservices/data-plane/AzureOpenAI/inference/stable/2024-10-21/inference.json"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "10184418268309769207"
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the API."
                      }
                    },
                    "apiManagementName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the API Management associated with the API."
                      }
                    },
                    "displayName": {
                      "type": "string",
                      "metadata": {
                        "description": "Display name of the API."
                      }
                    },
                    "path": {
                      "type": "string",
                      "metadata": {
                        "description": "Relative URL for the API and all of its resource paths associated with the API Management resource."
                      }
                    },
                    "format": {
                      "type": "string",
                      "allowedValues": [
                        "openapi",
                        "openapi+json",
                        "openapi+json-link",
                        "openapi-link"
                      ],
                      "metadata": {
                        "description": "Format for the OpenAPI specification."
                      }
                    },
                    "value": {
                      "type": "string",
                      "metadata": {
                        "description": "Value for the OpenAPI specification."
                      }
                    },
                    "loadBalancerName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "$fxv#0": "<policies>\r\n    <inbound>\r\n        <base />\r\n        <validate-jwt header-name=\"Authorization\" failed-validation-httpcode=\"401\" failed-validation-error-message=\"Missing or invalid bearer token.\">\r\n            <openid-config url=\"https://login.microsoftonline.com/{{tenant-id}}/v2.0/.well-known/openid-configuration\" />\r\n            <audiences>\r\n                <audience>https://cognitiveservices.azure.com</audience>\r\n            </audiences>\r\n        </validate-jwt>\r\n        <set-backend-service backend-id=\"{{load-balancer-name}}\" />\r\n        <authentication-managed-identity resource=\"https://cognitiveservices.azure.com\" output-token-variable-name=\"msi-access-token\" ignore-error=\"false\" />\r\n        <set-header name=\"Authorization\" exists-action=\"override\">\r\n            <value>@(\"Bearer \" + (string)context.Variables[\"msi-access-token\"])</value>\r\n        </set-header>\r\n    </inbound>\r\n    <backend>\r\n        <base />\r\n    </backend>\r\n    <outbound>\r\n        <base />\r\n    </outbound>\r\n    <on-error>\r\n        <base />\r\n    </on-error>\r\n</policies>"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/apis",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('apiManagementName'), parameters('name'))]",
                      "properties": {
                        "displayName": "[parameters('displayName')]",
                        "path": "[parameters('path')]",
                        "format": "[parameters('format')]",
                        "value": "[parameters('value')]",
                        "subscriptionRequired": false
                      }
                    },
                    {
                      "type": "Microsoft.ApiManagement/service/apis/policies",
                      "apiVersion": "2022-08-01",
                      "name": "[format('{0}/{1}/{2}', parameters('apiManagementName'), parameters('name'), 'policy')]",
                      "properties": {
                        "value": "[replace(replace(variables('$fxv#0'), '{{load-balancer-name}}', parameters('loadBalancerName')), '{{tenant-id}}', subscription().tenantId)]",
                        "format": "rawxml"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apiManagementName'), parameters('name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "metadata": {
                        "description": "ID for the deployed API Management API resource."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/apis', parameters('apiManagementName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the deployed API Management API resource."
                      },
                      "value": "[parameters('name')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "apimLoadBalancing"
              ]
            },
            "apimLogger": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-logger', parameters('apiManagementName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementName": {
                    "value": "[parameters('apiManagementName')]"
                  },
                  "appInsightsName": {
                    "value": "[parameters('appInsightsName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "13419558720047163159"
                    }
                  },
                  "parameters": {
                    "apiManagementName": {
                      "type": "string"
                    },
                    "appInsightsName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ApiManagement/service/loggers",
                      "apiVersion": "2023-05-01-preview",
                      "name": "[format('{0}/{1}', parameters('apiManagementName'), 'apimlogger')]",
                      "properties": {
                        "resourceId": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]",
                        "description": "Application Insights for APIM",
                        "loggerType": "applicationInsights",
                        "credentials": {
                          "instrumentationKey": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
                        }
                      }
                    }
                  ]
                }
              }
            },
            "apimLoadBalancing": {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}-loadbalancer', parameters('apiManagementName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "apiManagementName": {
                    "value": "[parameters('apiManagementName')]"
                  },
                  "openApiApimBackends": {
                    "value": "[parameters('openApiApimBackends')]"
                  },
                  "name": {
                    "value": "[variables('loadBalancerName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "12681305959569621248"
                    }
                  },
                  "definitions": {
                    "_1.apimSkuInfo": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "allowedValues": [
                            "BasicV2",
                            "PremiumV2",
                            "StandardV2"
                          ]
                        },
                        "capacity": {
                          "type": "int"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.functionValue": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "tag": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.keyVaultSecretsInfo": {
                      "type": "object",
                      "properties": {
                        "keyVaultName": {
                          "type": "string"
                        },
                        "primaryKeySecretName": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAIConfig": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "suffix": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int"
                        },
                        "embedding": {
                          "type": "object",
                          "properties": {
                            "capacity": {
                              "type": "int"
                            }
                          }
                        },
                        "completion": {
                          "type": "object",
                          "properties": {
                            "capacity": {
                              "type": "int"
                            },
                            "sku": {
                              "type": "string",
                              "allowedValues": [
                                "GlobalStandard",
                                "Standard"
                              ]
                            }
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAIConfigs": {
                      "type": "object",
                      "properties": {
                        "embeddingModel": {
                          "type": "string"
                        },
                        "completionModel": {
                          "type": "string"
                        },
                        "embeddingMaxTokens": {
                          "type": "int"
                        },
                        "configs": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/_1.openAIConfig"
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAiDeploymentInfo": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "host": {
                          "type": "string"
                        },
                        "endpoint": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int",
                          "nullable": true
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openApiApimBackends": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "id": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int",
                          "nullable": true
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.roleAssignmentInfo": {
                      "type": "object",
                      "properties": {
                        "roleDefinitionId": {
                          "type": "string"
                        },
                        "principalId": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../../constants/customTypes.bicep"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the Loadbalancer config."
                      }
                    },
                    "apiManagementName": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the API Management associated with the Backend."
                      }
                    },
                    "openApiApimBackends": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/_1.openApiApimBackends"
                      },
                      "metadata": {
                        "description": "URL of the Backend."
                      }
                    }
                  },
                  "variables": {
                    "copy": [
                      {
                        "name": "services",
                        "count": "[length(parameters('openApiApimBackends'))]",
                        "input": {
                          "id": "[parameters('openApiApimBackends')[copyIndex('services')].id]",
                          "priority": "[tryGet(parameters('openApiApimBackends')[copyIndex('services')], 'priority')]"
                        }
                      }
                    ]
                  },
                  "resources": {
                    "apiManagement": {
                      "existing": true,
                      "type": "Microsoft.ApiManagement/service",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[parameters('apiManagementName')]"
                    },
                    "loadbalancer": {
                      "type": "Microsoft.ApiManagement/service/backends",
                      "apiVersion": "2024-06-01-preview",
                      "name": "[format('{0}/{1}', parameters('apiManagementName'), parameters('name'))]",
                      "properties": {
                        "type": "Pool",
                        "pool": {
                          "services": "[variables('services')]"
                        }
                      }
                    }
                  },
                  "outputs": {
                    "id": {
                      "type": "string",
                      "metadata": {
                        "description": "ID for the deployed API Management Backend resource."
                      },
                      "value": "[resourceId('Microsoft.ApiManagement/service/backends', parameters('apiManagementName'), parameters('name'))]"
                    },
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name for the deployed API Management Backend resource."
                      },
                      "value": "[parameters('name')]"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "apiManagement",
        "appInsights",
        "rg",
        "roleAssigments"
      ]
    },
    "openAi": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "openAi",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "openAIInstances": {
            "value": "[parameters('openAiConfigs')]"
          },
          "instancePrefix": {
            "value": "[format('{0}{1}-', variables('abbrs').openAIService, parameters('appName'))]"
          },
          "managedIdentityId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "13713277329138985394"
            }
          },
          "definitions": {
            "_1.apimSkuInfo": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string",
                  "allowedValues": [
                    "BasicV2",
                    "PremiumV2",
                    "StandardV2"
                  ]
                },
                "capacity": {
                  "type": "int"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.functionValue": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.keyVaultSecretsInfo": {
              "type": "object",
              "properties": {
                "keyVaultName": {
                  "type": "string"
                },
                "primaryKeySecretName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "location": {
                  "type": "string"
                },
                "suffix": {
                  "type": "string"
                },
                "priority": {
                  "type": "int"
                },
                "embedding": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    }
                  }
                },
                "completion": {
                  "type": "object",
                  "properties": {
                    "capacity": {
                      "type": "int"
                    },
                    "sku": {
                      "type": "string",
                      "allowedValues": [
                        "GlobalStandard",
                        "Standard"
                      ]
                    }
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAIConfigs": {
              "type": "object",
              "properties": {
                "embeddingModel": {
                  "type": "string"
                },
                "completionModel": {
                  "type": "string"
                },
                "embeddingMaxTokens": {
                  "type": "int"
                },
                "configs": {
                  "type": "array",
                  "items": {
                    "$ref": "#/definitions/_1.openAIConfig"
                  }
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openAiDeploymentInfo": {
              "type": "object",
              "properties": {
                "id": {
                  "type": "string"
                },
                "name": {
                  "type": "string"
                },
                "host": {
                  "type": "string"
                },
                "endpoint": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.openApiApimBackends": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "id": {
                  "type": "string"
                },
                "priority": {
                  "type": "int",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.roleAssignmentInfo": {
              "type": "object",
              "properties": {
                "roleDefinitionId": {
                  "type": "string"
                },
                "principalId": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            }
          },
          "parameters": {
            "instancePrefix": {
              "type": "string"
            },
            "openAIInstances": {
              "$ref": "#/definitions/_1.openAIConfigs"
            },
            "managedIdentityId": {
              "type": "string"
            }
          },
          "resources": {
            "openAI": {
              "copy": {
                "name": "openAI",
                "count": "[length(parameters('openAIInstances').configs)]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[if(not(empty(tryGet(parameters('openAIInstances').configs[copyIndex()], 'name'))), parameters('openAIInstances').configs[copyIndex()].name, format('{0}{1}', parameters('instancePrefix'), parameters('openAIInstances').configs[copyIndex()].suffix))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "managedIdentityId": {
                    "value": "[parameters('managedIdentityId')]"
                  },
                  "name": "[if(not(empty(tryGet(parameters('openAIInstances').configs[copyIndex()], 'name'))), createObject('value', parameters('openAIInstances').configs[copyIndex()].name), createObject('value', format('{0}{1}', parameters('instancePrefix'), parameters('openAIInstances').configs[copyIndex()].suffix)))]",
                  "location": {
                    "value": "[parameters('openAIInstances').configs[copyIndex()].location]"
                  },
                  "openAiConfig": {
                    "value": "[parameters('openAIInstances').configs[copyIndex()]]"
                  },
                  "completionModel": {
                    "value": "[parameters('openAIInstances').completionModel]"
                  },
                  "embeddingModel": {
                    "value": "[parameters('openAIInstances').embeddingModel]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "languageVersion": "2.0",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "16702116295213497441"
                    }
                  },
                  "definitions": {
                    "_1.apimSkuInfo": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string",
                          "allowedValues": [
                            "BasicV2",
                            "PremiumV2",
                            "StandardV2"
                          ]
                        },
                        "capacity": {
                          "type": "int"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.functionValue": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "tag": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.keyVaultSecretsInfo": {
                      "type": "object",
                      "properties": {
                        "keyVaultName": {
                          "type": "string"
                        },
                        "primaryKeySecretName": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAIConfig": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "location": {
                          "type": "string"
                        },
                        "suffix": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int"
                        },
                        "embedding": {
                          "type": "object",
                          "properties": {
                            "capacity": {
                              "type": "int"
                            }
                          }
                        },
                        "completion": {
                          "type": "object",
                          "properties": {
                            "capacity": {
                              "type": "int"
                            },
                            "sku": {
                              "type": "string",
                              "allowedValues": [
                                "GlobalStandard",
                                "Standard"
                              ]
                            }
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAIConfigs": {
                      "type": "object",
                      "properties": {
                        "embeddingModel": {
                          "type": "string"
                        },
                        "completionModel": {
                          "type": "string"
                        },
                        "embeddingMaxTokens": {
                          "type": "int"
                        },
                        "configs": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/_1.openAIConfig"
                          }
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openAiDeploymentInfo": {
                      "type": "object",
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "name": {
                          "type": "string"
                        },
                        "host": {
                          "type": "string"
                        },
                        "endpoint": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int",
                          "nullable": true
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.openApiApimBackends": {
                      "type": "object",
                      "properties": {
                        "name": {
                          "type": "string"
                        },
                        "id": {
                          "type": "string"
                        },
                        "priority": {
                          "type": "int",
                          "nullable": true
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    },
                    "_1.roleAssignmentInfo": {
                      "type": "object",
                      "properties": {
                        "roleDefinitionId": {
                          "type": "string"
                        },
                        "principalId": {
                          "type": "string"
                        }
                      },
                      "metadata": {
                        "__bicep_imported_from!": {
                          "sourceTemplate": "../constants/customTypes.bicep"
                        }
                      }
                    }
                  },
                  "parameters": {
                    "name": {
                      "type": "string",
                      "metadata": {
                        "description": "Name of the resource."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location to deploy the resource. Defaults to the location of the resource group."
                      }
                    },
                    "tags": {
                      "type": "object",
                      "defaultValue": {},
                      "metadata": {
                        "description": "Tags for the resource."
                      }
                    },
                    "managedIdentityId": {
                      "type": "string"
                    },
                    "openAiConfig": {
                      "$ref": "#/definitions/_1.openAIConfig"
                    },
                    "completionModel": {
                      "type": "string"
                    },
                    "embeddingModel": {
                      "type": "string"
                    },
                    "publicNetworkAccess": {
                      "type": "string",
                      "defaultValue": "Enabled",
                      "allowedValues": [
                        "Enabled",
                        "Disabled"
                      ],
                      "metadata": {
                        "description": "Whether to enable public network access. Defaults to Enabled."
                      }
                    }
                  },
                  "resources": {
                    "cognitiveServices": {
                      "type": "Microsoft.CognitiveServices/accounts",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[parameters('name')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "kind": "OpenAI",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('managedIdentityId'))]": {}
                        }
                      },
                      "properties": {
                        "customSubDomainName": "[toLower(parameters('name'))]",
                        "publicNetworkAccess": "[parameters('publicNetworkAccess')]"
                      },
                      "sku": {
                        "name": "S0"
                      }
                    },
                    "completionDeployment": {
                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('name'), parameters('completionModel'))]",
                      "properties": {
                        "model": {
                          "format": "OpenAI",
                          "name": "[parameters('completionModel')]"
                        }
                      },
                      "sku": {
                        "name": "[parameters('openAiConfig').completion.sku]",
                        "capacity": "[parameters('openAiConfig').completion.capacity]"
                      },
                      "dependsOn": [
                        "cognitiveServices"
                      ]
                    },
                    "embeddingDeployment": {
                      "type": "Microsoft.CognitiveServices/accounts/deployments",
                      "apiVersion": "2023-10-01-preview",
                      "name": "[format('{0}/{1}', parameters('name'), parameters('embeddingModel'))]",
                      "properties": {
                        "model": {
                          "format": "OpenAI",
                          "name": "[parameters('embeddingModel')]"
                        }
                      },
                      "sku": {
                        "name": "Standard",
                        "capacity": "[parameters('openAiConfig').embedding.capacity]"
                      },
                      "dependsOn": [
                        "cognitiveServices",
                        "completionDeployment"
                      ]
                    }
                  },
                  "outputs": {
                    "openAiInfo": {
                      "$ref": "#/definitions/_1.openAiDeploymentInfo",
                      "value": {
                        "name": "[parameters('name')]",
                        "id": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]",
                        "host": "[reference('cognitiveServices').endpoint]",
                        "endpoint": "[reference('cognitiveServices').endpoint]"
                      }
                    }
                  }
                }
              }
            }
          },
          "outputs": {
            "openAIDeployments": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.openAiDeploymentInfo"
              },
              "copy": {
                "count": "[length(range(0, length(parameters('openAIInstances').configs)))]",
                "input": {
                  "id": "[reference(format('openAI[{0}]', range(0, length(parameters('openAIInstances').configs))[copyIndex()])).outputs.openAiInfo.value.id]",
                  "name": "[reference(format('openAI[{0}]', range(0, length(parameters('openAIInstances').configs))[copyIndex()])).outputs.openAiInfo.value.name]",
                  "host": "[format('https://{0}.openai.azure.com/', reference(format('openAI[{0}]', range(0, length(parameters('openAIInstances').configs))[copyIndex()])).outputs.openAiInfo.value.name)]",
                  "endpoint": "[format('https://{0}.openai.azure.com/openai/deployments/{1}/chat/completions?api-version=2023-10-01-preview', reference(format('openAI[{0}]', range(0, length(parameters('openAIInstances').configs))[copyIndex()])).outputs.openAiInfo.value.name, reference(format('openAI[{0}]', range(0, length(parameters('openAIInstances').configs))[copyIndex()])).outputs.openAiInfo.value.name)]",
                  "priority": "[parameters('openAIInstances').configs[range(0, length(parameters('openAIInstances').configs))[copyIndex()]].priority]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "managedIdentity",
        "rg"
      ]
    }
  },
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "openAINames": {
      "type": "array",
      "copy": {
        "count": "[length(range(0, length(parameters('openAiConfigs').configs)))]",
        "input": "[reference('openAi').outputs.openAIDeployments.value[range(0, length(parameters('openAiConfigs').configs))[copyIndex()]].name]"
      }
    },
    "openAiChatModel": {
      "type": "string",
      "value": "[parameters('openAiConfigs').completionModel]"
    },
    "openAiEmbeddingModel": {
      "type": "string",
      "value": "[parameters('openAiConfigs').embeddingModel]"
    },
    "apimName": {
      "type": "string",
      "value": "[reference('apiManagement').outputs.name.value]"
    }
  }
}