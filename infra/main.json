{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.34.44.8038",
      "templateHash": "4305907080678473402"
    }
  },
  "definitions": {
    "_1.foundryConfig": {
      "type": "object",
      "properties": {
        "accountName": {
          "type": "string"
        },
        "projectName": {
          "type": "string"
        },
        "projectDisplayName": {
          "type": "string"
        },
        "embeddingMaxTokens": {
          "type": "int"
        },
        "chatModel": {
          "$ref": "#/definitions/_1.foundryModelConfig"
        },
        "embeddingModel": {
          "$ref": "#/definitions/_1.foundryModelConfig"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.foundryModelConfig": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "version": {
          "type": "string"
        },
        "sku": {
          "type": "string"
        },
        "capacity": {
          "type": "int"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.functionValue": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "tag": {
          "type": "string"
        },
        "serviceName": {
          "type": "string",
          "nullable": true
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.keyVaultSecretsInfo": {
      "type": "object",
      "properties": {
        "keyVaultName": {
          "type": "string"
        },
        "primaryKeySecretName": {
          "type": "string"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    },
    "_1.roleAssignmentInfo": {
      "type": "object",
      "properties": {
        "roleDefinitionId": {
          "type": "string"
        },
        "principalId": {
          "type": "string"
        }
      },
      "metadata": {
        "__bicep_imported_from!": {
          "sourceTemplate": "constants/customTypes.bicep"
        }
      }
    }
  },
  "parameters": {
    "appName": {
      "type": "string"
    },
    "appNameSafe": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "myPublicIp": {
      "type": "string"
    },
    "docIntelligenceInstanceCount": {
      "type": "int"
    },
    "currentUserObjectId": {
      "type": "string"
    },
    "aiIndexName": {
      "type": "string",
      "defaultValue": "documentindex"
    },
    "serviceBusSku": {
      "type": "string",
      "defaultValue": "Standard"
    },
    "functionValues": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/_1.functionValue"
      }
    },
    "foundryConfig": {
      "$ref": "#/definitions/_1.foundryConfig",
      "metadata": {
        "description": "Azure AI Foundry deployment configuration."
      }
    },
    "foundryAgentId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Persistent agent identifier inside the Azure AI Foundry project (optional)."
      }
    }
  },
  "variables": {
    "$fxv#0": {
      "aiSearch": "srch-",
      "aiServices": "aisa-",
      "aiVideoIndexer": "avi-",
      "machineLearningWorkspace": "mlw-",
      "openAIService": "oai-",
      "botService": "bot-",
      "computerVision": "cv-",
      "contentModerator": "cm-",
      "contentSafety": "cs-",
      "customVisionPrediction": "cstv-",
      "customVisionTraining": "cstvt-",
      "documentIntelligence": "di-",
      "faceApi": "face-",
      "healthInsights": "hi-",
      "immersiveReader": "ir-",
      "languageService": "lang-",
      "speechService": "spch-",
      "translator": "trsl-",
      "aiWorkspace": "aiw-",
      "analysisServicesServer": "as",
      "databricksWorkspace": "dbw-",
      "dataExplorerCluster": "dec",
      "dataExplorerClusterDatabase": "dedb",
      "dataFactory": "adf-",
      "digitalTwin": "dt-",
      "streamAnalytics": "asa-",
      "synapseAnalyticsWorkspaces": "synw",
      "synapseAnalyticsSQLDedicatedPool": "syndp",
      "synapseAnalyticsSparkPool": "synsp",
      "dataLakeStoreAccount": "dls",
      "eventHubsNamespace": "evhns-",
      "eventHub": "evh-",
      "eventGridDomain": "evgd-",
      "eventGridSubscriptions": "evgs-",
      "eventGridTopic": "evgt-",
      "eventGridSystemTopic": "egst-",
      "hdInsightHadoopCluster": "hadoop-",
      "hdInsightHBaseCluster": "hbase-",
      "hdInsightKafkaCluster": "kafka-",
      "hdInsightSparkCluster": "spark-",
      "hdInsightStormCluster": "storm-",
      "hdInsightMLServicesCluster": "mls-",
      "iotHub": "iot-",
      "provisioningServices": "provs-",
      "provisioningServicesCertificate": "pcert-",
      "powerBIEmbedded": "pbi-",
      "timeSeriesInsightsEnvironment": "tsi-",
      "appServiceEnvironment": "ase-",
      "appServicePlan": "asp-",
      "loadTesting": "lt-",
      "availabilitySet": "avail-",
      "arcEnabledServer": "arcs-",
      "arcEnabledKubernetesCluster": "arck",
      "batchAccounts": "ba-",
      "cloudService": "cld-",
      "communicationServices": "acs-",
      "diskEncryptionSet": "des",
      "functionApp": "func-",
      "gallery": "gal",
      "hostingEnvironment": "host-",
      "imageTemplate": "it-",
      "managedDiskOS": "osdisk",
      "managedDiskData": "disk",
      "notificationHubs": "ntf-",
      "notificationHubsNamespace": "ntfns-",
      "proximityPlacementGroup": "ppg-",
      "snapshot": "snap-",
      "staticWebApp": "stapp-",
      "virtualMachine": "vm",
      "virtualMachineScaleSet": "vmss-",
      "virtualMachineMaintenanceConfiguration": "mc-",
      "virtualMachineStorageAccount": "stvm",
      "webApp": "app-",
      "aksCluster": "aks-",
      "containerApp": "ca-",
      "containerAppsEnvironment": "cae-",
      "containerRegistry": "cr",
      "containerInstance": "ci",
      "serviceFabricCluster": "sf-",
      "serviceFabricManagedCluster": "sfmc-",
      "cosmosDBDatabase": "cosmos-",
      "cosmosDBApacheCassandra": "coscas-",
      "cosmosDBMongoDB": "cosmon-",
      "cosmosDBNoSQL": "cosno-",
      "cosmosDBTable": "costab-",
      "cosmosDBGremlin": "cosgrm-",
      "cosmosDBPostgreSQL": "cospos-",
      "cacheForRedis": "redis-",
      "sqlDatabaseServer": "sql-",
      "sqlDatabase": "sqldb-",
      "sqlElasticJobAgent": "sqlja-",
      "sqlElasticPool": "sqlep-",
      "mariaDBServer": "maria-",
      "mariaDBDatabase": "mariadb-",
      "mySQLDatabase": "mysql-",
      "postgreSQLDatabase": "psql-",
      "sqlServerStretchDatabase": "sqlstrdb-",
      "sqlManagedInstance": "sqlmi-",
      "appConfigurationStore": "appcs-",
      "mapsAccount": "map-",
      "signalR": "sigr",
      "webPubSub": "wps-",
      "managedGrafana": "amg-",
      "apiManagementService": "apim-",
      "integrationAccount": "ia-",
      "logicApps": "logic-",
      "serviceBusNamespace": "sbns-",
      "serviceBusQueue": "sbq-",
      "serviceBusTopic": "sbt-",
      "serviceBusTopicSubscription": "sbts-",
      "automationAccount": "aa-",
      "applicationInsights": "appi-",
      "monitorActionGroup": "ag-",
      "monitorDataCollectionRules": "dcr-",
      "blueprint": "bp-",
      "blueprintAssignment": "bpa-",
      "logAnalyticsWorkspace": "log-",
      "logAnalyticsQueryPacks": "pack-",
      "managementGroup": "mg-",
      "purviewInstance": "pview-",
      "resourceGroup": "rg-",
      "templateSpecsName": "ts-",
      "migrateProject": "migr-",
      "databaseMigrationService": "dms-",
      "recoveryServicesVault": "rsv-",
      "applicationGateway": "agw-",
      "applicationSecurityGroup": "asg-",
      "cdnProfile": "cdnp-",
      "cdnEndpoint": "cdne-",
      "connections": "con-",
      "dnsPrivateResolver": "dnspr-",
      "dnsPrivateResolverInboundEndpoint": "in-",
      "dnsPrivateResolverOutboundEndpoint": "out-",
      "firewall": "afw-",
      "firewallPolicy": "afwp-",
      "expressRouteCircuit": "erc-",
      "frontDoorProfile": "afd-",
      "frontDoorEndpoint": "fde-",
      "frontDoorFirewallPolicy": "fdfp-",
      "loadBalancerInternal": "lbi-",
      "loadBalancerExternal": "lbe-",
      "loadBalancerRule": "rule-",
      "localNetworkGateway": "lgw-",
      "natGateway": "ng-",
      "networkInterface": "nic-",
      "networkSecurityGroup": "nsg-",
      "networkSecurityGroupSecurityRules": "nsgsr-",
      "networkWatcher": "nw-",
      "privateLink": "pl-",
      "privateEndpoint": "pep-",
      "publicIPAddress": "pip-",
      "publicIPAddressPrefix": "ippre-",
      "routeFilter": "rf-",
      "routeServer": "rtserv-",
      "routeTable": "rt-",
      "serviceEndpointPolicy": "se-",
      "trafficManagerProfile": "traf-",
      "userDefinedRoute": "udr-",
      "virtualNetwork": "vnet-",
      "virtualNetworkGateway": "vgw-",
      "virtualNetworkManager": "vnm-",
      "virtualNetworkPeering": "peer-",
      "virtualNetworkSubnet": "snet-",
      "virtualWAN": "vwan-",
      "virtualWANHub": "vhub-",
      "bastion": "bas-",
      "keyVault": "kv-",
      "keyVaultManagedHSM": "kvmhsm-",
      "managedIdentity": "id-",
      "vpnGateway": "vpng-",
      "vpnConnection": "vcn-",
      "vpnSite": "vst-",
      "webApplicationFirewallPolicy": "waf",
      "webApplicationFirewallPolicyRuleGroup": "wafrg",
      "storSimple": "ssimp",
      "backupVault": "bvault-",
      "backupVaultPolicy": "bkpol-",
      "fileShare": "share-",
      "storageAccount": "st",
      "storageSyncService": "sss-",
      "virtualDesktopHostPool": "vdpool-",
      "virtualDesktopApplicationGroup": "vdag-",
      "virtualDesktopWorkspace": "vdws-",
      "virtualDesktopScalingPlan": "vdscaling-"
    },
    "abbrs": "[variables('$fxv#0')]",
    "appNameLc": "[toLower(parameters('appNameSafe'))]",
    "resourceGroupName": "[format('{0}{1}', variables('abbrs').resourceGroup, parameters('appName'))]",
    "serviceBusNs": "[format('{0}{1}-{2}', variables('abbrs').serviceBusNamespace, parameters('appName'), parameters('location'))]",
    "formStorageBase": "[format('{0}{1}{2}', variables('abbrs').storageAccount, variables('appNameLc'), parameters('location'))]",
    "formStorageAcct": "[if(greater(length(variables('formStorageBase')), 24), substring(variables('formStorageBase'), 0, 24), variables('formStorageBase'))]",
    "funcStorageBase": "[format('{0}{1}func{2}', variables('abbrs').storageAccount, variables('appNameLc'), parameters('location'))]",
    "funcStorageAcct": "[if(greater(length(variables('funcStorageBase')), 24), substring(variables('funcStorageBase'), 0, 24), variables('funcStorageBase'))]",
    "docIntelligence": "[format('{0}{1}{2}', variables('abbrs').documentIntelligence, parameters('appName'), parameters('location'))]",
    "vnet": "[format('{0}{1}-{2}', variables('abbrs').virtualNetwork, parameters('appName'), parameters('location'))]",
    "subnet": "[format('{0}{1}-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "nsg": "[format('{0}{1}-{2}', variables('abbrs').networkSecurityGroup, parameters('appName'), parameters('location'))]",
    "funcsubnet": "[format('{0}{1}-func-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "apimsubnet": "[format('{0}{1}-apim-{2}', variables('abbrs').virtualNetworkSubnet, parameters('appName'), parameters('location'))]",
    "containerRegistryBase": "[toLower(format('{0}{1}{2}', variables('abbrs').containerRegistry, variables('appNameLc'), parameters('location')))]",
    "containerRegistryName": "[if(greater(length(variables('containerRegistryBase')), 50), substring(variables('containerRegistryBase'), 0, 50), variables('containerRegistryBase'))]",
    "containerAppEnvironmentBase": "[toLower(format('{0}{1}-{2}', variables('abbrs').containerAppsEnvironment, parameters('appName'), parameters('location')))]",
    "containerAppEnvironmentName": "[if(greater(length(variables('containerAppEnvironmentBase')), 32), substring(variables('containerAppEnvironmentBase'), 0, 32), variables('containerAppEnvironmentBase'))]",
    "keyvaultNameBase": "[format('{0}{1}-{2}', variables('abbrs').keyVault, parameters('appName'), parameters('location'))]",
    "keyvaultName": "[if(greater(length(variables('keyvaultNameBase')), 24), substring(variables('keyvaultNameBase'), 0, 24), variables('keyvaultNameBase'))]",
    "aiSearchName": "[format('{0}{1}-demo-{2}', variables('abbrs').aiSearch, variables('appNameLc'), parameters('location'))]",
    "appInsightsName": "[format('{0}{1}-{2}', variables('abbrs').applicationInsights, parameters('appName'), parameters('location'))]",
    "logAnalyticsName": "[format('{0}{1}-{2}', variables('abbrs').logAnalyticsWorkspace, parameters('appName'), parameters('location'))]",
    "managedIdentityName": "[format('{0}{1}-{2}', variables('abbrs').managedIdentity, parameters('appName'), parameters('location'))]",
    "cosmosDbName": "documentIndexing",
    "cosmosContainerName": "processTracker",
    "cosmosDbAccountName": "[toLower(format('{0}{1}-{2}', variables('abbrs').cosmosDBNoSQL, parameters('appName'), parameters('location')))]",
    "documentStorageContainer": "documents",
    "processResultsContainer": "processresults",
    "completedContainer": "completed",
    "customFieldQueueName": "customfieldqueue",
    "docQueueName": "docqueue",
    "moveQueueName": "movequeue",
    "toIndexQueueName": "toindexqueue"
  },
  "resources": {
    "rg": {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": {
        "SecurityControl": "Ignore"
      }
    },
    "managedIdentity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "managedIdentity",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('managedIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "15617797963517012510"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the resource."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location to deploy the resource. Defaults to the location of the resource group."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags for the resource."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "metadata": {
                "description": "ID for the deployed Managed Identity resource."
              },
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the deployed Managed Identity resource."
              },
              "value": "[parameters('name')]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID for the deployed Managed Identity resource."
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID for the deployed Managed Identity resource."
              },
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "foundry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "foundry",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('foundryConfig').accountName]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": {
              "CreatedBy": "[parameters('currentUserObjectId')]"
            }
          },
          "managedIdentityId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          },
          "projectName": {
            "value": "[parameters('foundryConfig').projectName]"
          },
          "projectDisplayName": {
            "value": "[parameters('foundryConfig').projectDisplayName]"
          },
          "chatModelName": {
            "value": "[parameters('foundryConfig').chatModel.name]"
          },
          "chatModelVersion": {
            "value": "[parameters('foundryConfig').chatModel.version]"
          },
          "chatSku": {
            "value": "[parameters('foundryConfig').chatModel.sku]"
          },
          "chatCapacity": {
            "value": "[parameters('foundryConfig').chatModel.capacity]"
          },
          "embeddingModelName": {
            "value": "[parameters('foundryConfig').embeddingModel.name]"
          },
          "embeddingModelVersion": {
            "value": "[parameters('foundryConfig').embeddingModel.version]"
          },
          "embeddingSku": {
            "value": "[parameters('foundryConfig').embeddingModel.sku]"
          },
          "embeddingCapacity": {
            "value": "[parameters('foundryConfig').embeddingModel.capacity]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "972618327593776244"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "tags": {
              "type": "object",
              "defaultValue": {}
            },
            "managedIdentityId": {
              "type": "string"
            },
            "projectName": {
              "type": "string"
            },
            "projectDisplayName": {
              "type": "string"
            },
            "chatModelName": {
              "type": "string"
            },
            "chatModelVersion": {
              "type": "string"
            },
            "chatSku": {
              "type": "string",
              "defaultValue": "Standard"
            },
            "chatCapacity": {
              "type": "int",
              "defaultValue": 1
            },
            "embeddingModelName": {
              "type": "string"
            },
            "embeddingModelVersion": {
              "type": "string"
            },
            "embeddingSku": {
              "type": "string",
              "defaultValue": "Standard"
            },
            "embeddingCapacity": {
              "type": "int",
              "defaultValue": 1
            }
          },
          "variables": {
            "customSubdomain": "[toLower(parameters('name'))]",
            "servicesEndpoint": "[format('https://{0}.services.ai.azure.com', variables('customSubdomain'))]"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AIServices",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "sku": {
                "name": "S0"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('name'), parameters('chatModelName'))]",
              "sku": {
                "name": "[parameters('chatSku')]",
                "capacity": "[parameters('chatCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('chatModelName')]",
                  "version": "[parameters('chatModelVersion')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('name'), parameters('embeddingModelName'))]",
              "sku": {
                "name": "[parameters('embeddingSku')]",
                "capacity": "[parameters('embeddingCapacity')]"
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "[parameters('embeddingModelName')]",
                  "version": "[parameters('embeddingModelVersion')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-07-01-preview",
              "name": "[format('{0}/{1}', parameters('name'), parameters('projectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "displayName": "[parameters('projectDisplayName')]",
                "description": "Generated via infrastructure-as-code for Document Intelligence and AI Search indexing."
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "accountName": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "accountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('name'))]"
            },
            "projectResourceName": {
              "type": "string",
              "value": "[parameters('projectName')]"
            },
            "projectEndpoint": {
              "type": "string",
              "value": "[format('{0}/api/projects/{1}', variables('servicesEndpoint'), parameters('projectName'))]"
            },
            "inferenceEndpoint": {
              "type": "string",
              "value": "[format('{0}/models', variables('servicesEndpoint'))]"
            },
            "servicesEndpointHost": {
              "type": "string",
              "value": "[variables('servicesEndpoint')]"
            },
            "chatDeploymentName": {
              "type": "string",
              "value": "[parameters('chatModelName')]"
            },
            "embeddingDeploymentName": {
              "type": "string",
              "value": "[parameters('embeddingModelName')]"
            },
            "embeddingModel": {
              "type": "string",
              "value": "[parameters('embeddingModelName')]"
            },
            "chatModel": {
              "type": "string",
              "value": "[parameters('chatModelName')]"
            }
          }
        }
      },
      "dependsOn": [
        "managedIdentity",
        "rg"
      ]
    },
    "networkSecurityGroup": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networkSecurityGroup",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsg": {
            "value": "[variables('nsg')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "11516563349655266862"
            }
          },
          "parameters": {
            "nsg": {
              "type": "string"
            },
            "myPublicIp": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-02-01",
              "name": "[parameters('nsg')]",
              "location": "[parameters('location')]"
            },
            {
              "condition": "[not(equals(parameters('myPublicIp'), ''))]",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'AllowLocalIP')]",
              "properties": {
                "sourceAddressPrefix": "[parameters('myPublicIp')]",
                "destinationAddressPrefix": "*",
                "sourcePortRange": "*",
                "destinationPortRange": "*",
                "priority": 500,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'InternetToVnetInbound')]",
              "properties": {
                "sourceAddressPrefix": "Internet",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 505,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'trafficManagertoVnetOutbound')]",
              "properties": {
                "sourceAddressPrefix": "AzureTrafficManager",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 600,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'ApimManagementInbound')]",
              "properties": {
                "sourceAddressPrefix": "ApiManagement",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "3443",
                "priority": 510,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'LoadBalancerToVnetInbound')]",
              "properties": {
                "sourceAddressPrefix": "AzureLoadBalancer",
                "destinationAddressPrefix": "VirtualNetwork",
                "sourcePortRange": "*",
                "destinationPortRange": "6390",
                "priority": 520,
                "access": "Allow",
                "direction": "Inbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToStorageOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "Storage",
                "sourcePortRange": "*",
                "destinationPortRange": "443",
                "priority": 530,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToSQLOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "SQL",
                "sourcePortRange": "*",
                "destinationPortRange": "1443",
                "priority": 540,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToKeyVaultOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "AzureKeyVault",
                "sourcePortRange": "*",
                "destinationPortRange": "433",
                "priority": 550,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-02-01",
              "name": "[format('{0}/{1}', parameters('nsg'), 'VnetToAzureMonitorOutbound')]",
              "properties": {
                "sourceAddressPrefix": "VirtualNetwork",
                "destinationAddressPrefix": "AzureMonitor",
                "sourcePortRange": "*",
                "destinationPortRanges": [
                  "443",
                  "1886"
                ],
                "priority": 560,
                "access": "Allow",
                "direction": "Outbound",
                "protocol": "Tcp"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "cosmosDb": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmosDb",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "databaseName": {
            "value": "[variables('cosmosDbName')]"
          },
          "cosmosContainerName": {
            "value": "[variables('cosmosContainerName')]"
          },
          "cosmosDbAccountName": {
            "value": "[variables('cosmosDbAccountName')]"
          },
          "functionSubnetId": {
            "value": "[reference('networking').outputs.functionSubnetId.value]"
          },
          "apimSubnetId": {
            "value": "[reference('networking').outputs.apimSubnetId.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetName": {
            "value": "[variables('vnet')]"
          },
          "subnetName": {
            "value": "[variables('subnet')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "862983272309652473"
            }
          },
          "parameters": {
            "cosmosDbAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Cosmos DB account"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the Cosmos DB account"
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "The name of the database to create"
              }
            },
            "cosmosContainerName": {
              "type": "string"
            },
            "vnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Virtual Network"
              }
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet for the service endpoint"
              }
            },
            "myPublicIp": {
              "type": "string",
              "defaultValue": ""
            },
            "functionSubnetId": {
              "type": "string"
            },
            "apimSubnetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2021-10-15",
              "name": "[parameters('cosmosDbAccountName')]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "publicNetworkAccess": "Enabled",
                "isVirtualNetworkFilterEnabled": true,
                "virtualNetworkRules": [
                  {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]",
                    "ignoreMissingVNetServiceEndpoint": false
                  },
                  {
                    "id": "[parameters('functionSubnetId')]",
                    "ignoreMissingVNetServiceEndpoint": false
                  },
                  {
                    "id": "[parameters('apimSubnetId')]",
                    "ignoreMissingVNetServiceEndpoint": false
                  }
                ],
                "ipRules": "[if(not(empty(parameters('myPublicIp'))), createArray(createObject('ipAddressOrRange', parameters('myPublicIp'))), createArray())]",
                "enableFreeTier": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2021-10-15",
              "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2021-10-15",
              "name": "[format('{0}/{1}/{2}', parameters('cosmosDbAccountName'), parameters('databaseName'), parameters('cosmosContainerName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('cosmosContainerName')]",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('cosmosDbAccountName'), parameters('databaseName'))]"
              ]
            }
          ],
          "outputs": {
            "cosmosDbAccountName": {
              "type": "string",
              "value": "[parameters('cosmosDbAccountName')]"
            },
            "cosmosDbDatabaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "cosmosDbEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), '2021-10-15').documentEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "networking": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networking",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "vnet": {
            "value": "[variables('vnet')]"
          },
          "subnet": {
            "value": "[variables('subnet')]"
          },
          "nsg": {
            "value": "[variables('nsg')]"
          },
          "funcsubnet": {
            "value": "[variables('funcsubnet')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "apimsubnet": {
            "value": "[variables('apimsubnet')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "6488655325952190792"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "nsg": {
              "type": "string"
            },
            "vnet": {
              "type": "string"
            },
            "subnet": {
              "type": "string"
            },
            "funcsubnet": {
              "type": "string"
            },
            "apimsubnet": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-02-01",
              "name": "[parameters('vnet')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "10.10.0.0/16"
                  ]
                },
                "subnets": [
                  {
                    "name": "[parameters('funcsubnet')]",
                    "properties": {
                      "addressPrefix": "10.10.4.0/23",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.Web",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      }
                    }
                  },
                  {
                    "name": "[parameters('apimsubnet')]",
                    "properties": {
                      "addressPrefix": "10.10.2.0/24",
                      "delegations": [
                        {
                          "name": "Microsoft.Web/serverFarms",
                          "properties": {
                            "serviceName": "Microsoft.Web/serverFarms"
                          }
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      },
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.EventHub",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.KeyVault",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.Sql",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "*"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ]
                    }
                  },
                  {
                    "name": "[parameters('subnet')]",
                    "properties": {
                      "addressPrefix": "10.10.0.0/24",
                      "serviceEndpoints": [
                        {
                          "service": "Microsoft.Storage",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.Web",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.ServiceBus",
                          "locations": [
                            "[parameters('location')]"
                          ]
                        },
                        {
                          "service": "Microsoft.AzureCosmosDB",
                          "locations": [
                            "*"
                          ]
                        }
                      ],
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsg'))]"
                      }
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "storageSubnetIds": {
              "type": "array",
              "value": [
                "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].id]",
                "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[2].id]"
              ]
            },
            "vnetName": {
              "type": "string",
              "value": "[parameters('vnet')]"
            },
            "functionSubnetName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].name]"
            },
            "functionSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[0].id]"
            },
            "apimSubnetId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('vnet')), '2021-02-01').subnets[1].id]"
            }
          }
        }
      },
      "dependsOn": [
        "networkSecurityGroup",
        "rg"
      ]
    },
    "appInsights": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appInsigts",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "logAnalyticsName": {
            "value": "[variables('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "7903147441951196652"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string"
            },
            "logAnalyticsName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled",
                "WorkspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsName')]",
              "location": "[parameters('location')]",
              "properties": {
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "name": {
              "type": "string",
              "value": "[parameters('appInsightsName')]"
            },
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "logAnalyticsResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName'))]"
            },
            "logAnalyticsCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2022-10-01').customerId]"
            },
            "logAnalyticsSharedKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsName')), '2020-08-01').primarySharedKey]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "storage": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storage",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "formStorageAcct": {
            "value": "[variables('formStorageAcct')]"
          },
          "funcStorageAcct": {
            "value": "[variables('funcStorageAcct')]"
          },
          "myPublicIp": {
            "value": "[parameters('myPublicIp')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetIds": {
            "value": "[reference('networking').outputs.storageSubnetIds.value]"
          },
          "completedContainer": {
            "value": "[variables('completedContainer')]"
          },
          "documentStorageContainer": {
            "value": "[variables('documentStorageContainer')]"
          },
          "processResultsContainer": {
            "value": "[variables('processResultsContainer')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "16616409398590983899"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "formStorageAcct": {
              "type": "string"
            },
            "funcStorageAcct": {
              "type": "string"
            },
            "myPublicIp": {
              "type": "string"
            },
            "subnetIds": {
              "type": "array"
            },
            "documentStorageContainer": {
              "type": "string"
            },
            "processResultsContainer": {
              "type": "string"
            },
            "completedContainer": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('formStorageAcct')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "minimumTlsVersion": "TLS1_2",
                "allowBlobPublicAccess": false,
                "networkAcls": {
                  "copy": [
                    {
                      "name": "virtualNetworkRules",
                      "count": "[length(parameters('subnetIds'))]",
                      "input": {
                        "id": "[parameters('subnetIds')[copyIndex('virtualNetworkRules')]]",
                        "action": "Allow"
                      }
                    }
                  ],
                  "defaultAction": "Deny",
                  "ipRules": "[if(not(empty(parameters('myPublicIp'))), createArray(createObject('value', parameters('myPublicIp'), 'action', 'Allow')), createArray())]"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('formStorageAcct'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('formStorageAcct'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('documentStorageContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('processResultsContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}/{2}', parameters('formStorageAcct'), 'default', parameters('completedContainer'))]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('formStorageAcct'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-06-01",
              "name": "[parameters('funcStorageAcct')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2"
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('formStorageAcct'))]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "docIntelligenceService": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "docintelligence",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "docIntelligenceName": {
            "value": "[variables('docIntelligence')]"
          },
          "docIntelligenceInstanceCount": {
            "value": "[parameters('docIntelligenceInstanceCount')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "6261066906355335768"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "docIntelligenceName": {
              "type": "string"
            },
            "docIntelligenceInstanceCount": {
              "type": "int",
              "defaultValue": 1
            }
          },
          "resources": [
            {
              "copy": {
                "name": "docIntelligenceAccount",
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]"
              },
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-10-01-preview",
              "name": "[format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()], 2, '0'))]",
              "location": "[parameters('location')]",
              "kind": "FormRecognizer",
              "sku": {
                "name": "S0"
              },
              "properties": {
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": true,
                "customSubDomainName": "[format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()], 2, '0'))]"
              },
              "identity": {
                "type": "SystemAssigned"
              }
            }
          ],
          "outputs": {
            "docIntelligenceAccountName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[0], 2, '0'))), '2023-10-01-preview').endpoint]"
            },
            "docIntelligenceAccountIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[resourceId('Microsoft.CognitiveServices/accounts', format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0')))]"
              }
            },
            "docIntelligencePrincipalIds": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0'))), '2023-10-01-preview', 'full').identity.principalId]"
              }
            },
            "docIntellEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[0], 2, '0'))), '2023-10-01-preview').endpoint]"
            },
            "docIntellEndpoints": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('docIntelligenceInstanceCount')))]",
                "input": "[reference(resourceId('Microsoft.CognitiveServices/accounts', format('{0}-{1}', parameters('docIntelligenceName'), padLeft(range(0, parameters('docIntelligenceInstanceCount'))[range(0, parameters('docIntelligenceInstanceCount'))[copyIndex()]], 2, '0'))), '2023-10-01-preview').endpoint]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "servicebus": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "serviceBus",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "serviceBusNs": {
            "value": "[variables('serviceBusNs')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "docQueueName": {
            "value": "[variables('docQueueName')]"
          },
          "moveQueueName": {
            "value": "[variables('moveQueueName')]"
          },
          "toIndexQueueName": {
            "value": "[variables('toIndexQueueName')]"
          },
          "customFieldQueueName": {
            "value": "[variables('customFieldQueueName')]"
          },
          "subnetName": {
            "value": "[variables('funcsubnet')]"
          },
          "vnetName": {
            "value": "[variables('vnet')]"
          },
          "serviceBusSku": {
            "value": "[parameters('serviceBusSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "7226094278711892524"
            }
          },
          "parameters": {
            "serviceBusNs": {
              "type": "string"
            },
            "docQueueName": {
              "type": "string"
            },
            "moveQueueName": {
              "type": "string"
            },
            "toIndexQueueName": {
              "type": "string"
            },
            "customFieldQueueName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "serviceBusSku": {
              "type": "string",
              "defaultValue": "Standard"
            },
            "vnetName": {
              "type": "string",
              "defaultValue": ""
            },
            "subnetName": {
              "type": "string",
              "defaultValue": ""
            }
          },
          "variables": {
            "enablePartitioning": "[not(equals(parameters('serviceBusSku'), 'Premium'))]",
            "includeNetworking": "[equals(parameters('serviceBusSku'), 'Premium')]"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-10-01-preview",
              "name": "[parameters('serviceBusNs')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('serviceBusSku')]"
              }
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('docQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('moveQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('toIndexQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-10-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), parameters('customFieldQueueName'))]",
              "properties": {
                "enablePartitioning": "[variables('enablePartitioning')]",
                "maxSizeInMegabytes": 4096
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            },
            {
              "condition": "[variables('includeNetworking')]",
              "type": "Microsoft.ServiceBus/namespaces/networkRuleSets",
              "apiVersion": "2021-06-01-preview",
              "name": "[format('{0}/{1}', parameters('serviceBusNs'), 'default')]",
              "properties": {
                "defaultAction": "Deny",
                "trustedServiceAccessEnabled": true,
                "virtualNetworkRules": [
                  {
                    "subnet": {
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), parameters('subnetName'))]"
                    },
                    "ignoreMissingVnetServiceEndpoint": false
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
              ]
            }
          ],
          "outputs": {
            "serviceBusId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ServiceBus/namespaces', parameters('serviceBusNs'))]"
            },
            "serviceBusFullyQualifiedNamespace": {
              "type": "string",
              "value": "[format('{0}.servicebus.windows.net', parameters('serviceBusNs'))]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "keyvault": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyvault",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[variables('keyvaultName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "14572934140426015286"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[subscription().tenantId]",
                "enabledForDeployment": true,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": true,
                "enableSoftDelete": true,
                "enablePurgeProtection": true,
                "enableRbacAuthorization": true
              }
            }
          ],
          "outputs": {
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
            },
            "keyVaultName": {
              "type": "string",
              "value": "[parameters('keyVaultName')]"
            }
          }
        }
      },
      "dependsOn": [
        "networking",
        "rg"
      ]
    },
    "containerRegistry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "containerRegistry",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "registryName": {
            "value": "[variables('containerRegistryName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "14745053921753412780"
            }
          },
          "parameters": {
            "registryName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "registrySku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ]
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('registryName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('registrySku')]"
              },
              "properties": {
                "adminUserEnabled": false,
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('registryName')]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('registryName')), '2023-07-01').loginServer]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    },
    "managedIdentityAcrPull": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "managedIdentityAcrPull",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerRegistryName": {
            "value": "[variables('containerRegistryName')]"
          },
          "principalId": {
            "value": "[reference('managedIdentity').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "5758010663509133825"
            }
          },
          "parameters": {
            "containerRegistryName": {
              "type": "string"
            },
            "principalId": {
              "type": "string"
            }
          },
          "variables": {
            "acrPullRoleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
              "name": "[guid(parameters('principalId'), variables('acrPullRoleDefinitionId'), resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')))]",
              "properties": {
                "roleDefinitionId": "[variables('acrPullRoleDefinitionId')]",
                "principalId": "[parameters('principalId')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "containerRegistry",
        "managedIdentity",
        "rg"
      ]
    },
    "containerEnvironment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "containerEnvironment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('containerAppEnvironmentName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsCustomerId": {
            "value": "[reference('appInsights').outputs.logAnalyticsCustomerId.value]"
          },
          "logAnalyticsSharedKey": {
            "value": "[reference('appInsights').outputs.logAnalyticsSharedKey.value]"
          },
          "infrastructureSubnetId": {
            "value": "[reference('networking').outputs.functionSubnetId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "8948705875547871232"
            }
          },
          "parameters": {
            "name": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "logAnalyticsCustomerId": {
              "type": "string"
            },
            "logAnalyticsSharedKey": {
              "type": "string"
            },
            "infrastructureSubnetId": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2022-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[parameters('logAnalyticsCustomerId')]",
                    "sharedKey": "[parameters('logAnalyticsSharedKey')]"
                  }
                },
                "vnetConfiguration": {
                  "infrastructureSubnetId": "[parameters('infrastructureSubnetId')]"
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      },
      "dependsOn": [
        "appInsights",
        "networking",
        "rg"
      ]
    },
    "functions": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "functions",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "functionValues": {
            "value": "[parameters('functionValues')]"
          },
          "managedEnvironmentId": {
            "value": "[reference('containerEnvironment').outputs.id.value]"
          },
          "containerRegistryServer": {
            "value": "[reference('containerRegistry').outputs.loginServer.value]"
          },
          "containerRegistryIdentityResourceId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          },
          "managedIdentityId": {
            "value": "[reference('managedIdentity').outputs.id.value]"
          },
          "managedIdentityClientId": {
            "value": "[reference('managedIdentity').outputs.clientId.value]"
          },
          "formStorageAcctName": {
            "value": "[variables('formStorageAcct')]"
          },
          "documentStorageContainer": {
            "value": "[variables('documentStorageContainer')]"
          },
          "processResultsContainer": {
            "value": "[variables('processResultsContainer')]"
          },
          "completedContainer": {
            "value": "[variables('completedContainer')]"
          },
          "serviceBusNs": {
            "value": "[variables('serviceBusNs')]"
          },
          "docQueueName": {
            "value": "[variables('docQueueName')]"
          },
          "customFieldQueueName": {
            "value": "[variables('customFieldQueueName')]"
          },
          "moveQueueName": {
            "value": "[variables('moveQueueName')]"
          },
          "toIndexQueueName": {
            "value": "[variables('toIndexQueueName')]"
          },
          "aiSearchEndpoint": {
            "value": "[reference('aiSearch').outputs.aiSearchEndpoint.value]"
          },
          "foundryProjectEndpoint": {
            "value": "[reference('foundry').outputs.projectEndpoint.value]"
          },
          "foundryInferenceEndpoint": {
            "value": "[reference('foundry').outputs.inferenceEndpoint.value]"
          },
          "cosmosDbEndpoint": {
            "value": "[reference('cosmosDb').outputs.cosmosDbEndpoint.value]"
          },
          "serviceBusFullyQualifiedNamespace": {
            "value": "[reference('servicebus').outputs.serviceBusFullyQualifiedNamespace.value]"
          },
          "documentIntelligenceEndpoint": {
            "value": "[reference('docIntelligenceService').outputs.docIntellEndpoint.value]"
          },
          "documentIntelligenceEndpoints": {
            "value": "[string(reference('docIntelligenceService').outputs.docIntellEndpoints.value)]"
          },
          "foundryEmbeddingMaxTokens": {
            "value": "[parameters('foundryConfig').embeddingMaxTokens]"
          },
          "aiIndexName": {
            "value": "[parameters('aiIndexName')]"
          },
          "foundryChatDeployment": {
            "value": "[reference('foundry').outputs.chatDeploymentName.value]"
          },
          "foundryEmbeddingModel": {
            "value": "[reference('foundry').outputs.embeddingModel.value]"
          },
          "foundryEmbeddingDeployment": {
            "value": "[reference('foundry').outputs.embeddingDeploymentName.value]"
          },
          "foundryAgentId": {
            "value": "[parameters('foundryAgentId')]"
          },
          "cosmosDbName": {
            "value": "[variables('cosmosDbName')]"
          },
          "cosmosContainerName": {
            "value": "[variables('cosmosContainerName')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference('appInsights').outputs.connectionString.value]"
          },
          "appInsightsInstrumentationKey": {
            "value": "[reference('appInsights').outputs.instrumentationKey.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "6475242553480648705"
            }
          },
          "definitions": {
            "_1.foundryConfig": {
              "type": "object",
              "properties": {
                "accountName": {
                  "type": "string"
                },
                "projectName": {
                  "type": "string"
                },
                "projectDisplayName": {
                  "type": "string"
                },
                "embeddingMaxTokens": {
                  "type": "int"
                },
                "chatModel": {
                  "$ref": "#/definitions/_1.foundryModelConfig"
                },
                "embeddingModel": {
                  "$ref": "#/definitions/_1.foundryModelConfig"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.foundryModelConfig": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "version": {
                  "type": "string"
                },
                "sku": {
                  "type": "string"
                },
                "capacity": {
                  "type": "int"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.functionValue": {
              "type": "object",
              "properties": {
                "name": {
                  "type": "string"
                },
                "tag": {
                  "type": "string"
                },
                "serviceName": {
                  "type": "string",
                  "nullable": true
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.keyVaultSecretsInfo": {
              "type": "object",
              "properties": {
                "keyVaultName": {
                  "type": "string"
                },
                "primaryKeySecretName": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            },
            "_1.roleAssignmentInfo": {
              "type": "object",
              "properties": {
                "roleDefinitionId": {
                  "type": "string"
                },
                "principalId": {
                  "type": "string"
                }
              },
              "metadata": {
                "__bicep_imported_from!": {
                  "sourceTemplate": "../constants/customTypes.bicep"
                }
              }
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "functionValues": {
              "type": "array",
              "items": {
                "$ref": "#/definitions/_1.functionValue"
              }
            },
            "managedEnvironmentId": {
              "type": "string"
            },
            "containerRegistryServer": {
              "type": "string"
            },
            "containerRegistryIdentityResourceId": {
              "type": "string",
              "metadata": {
                "description": "Identity used by the Container Apps runtime to pull from the registry. Typically the user-assigned managed identity id."
              }
            },
            "managedIdentityId": {
              "type": "string"
            },
            "managedIdentityClientId": {
              "type": "string"
            },
            "formStorageAcctName": {
              "type": "string"
            },
            "documentStorageContainer": {
              "type": "string"
            },
            "processResultsContainer": {
              "type": "string"
            },
            "completedContainer": {
              "type": "string"
            },
            "serviceBusNs": {
              "type": "string"
            },
            "docQueueName": {
              "type": "string"
            },
            "customFieldQueueName": {
              "type": "string"
            },
            "moveQueueName": {
              "type": "string"
            },
            "toIndexQueueName": {
              "type": "string"
            },
            "aiSearchEndpoint": {
              "type": "string"
            },
            "foundryProjectEndpoint": {
              "type": "string"
            },
            "foundryInferenceEndpoint": {
              "type": "string"
            },
            "cosmosDbEndpoint": {
              "type": "string"
            },
            "serviceBusFullyQualifiedNamespace": {
              "type": "string"
            },
            "documentIntelligenceEndpoint": {
              "type": "string"
            },
            "documentIntelligenceEndpoints": {
              "type": "string"
            },
            "foundryEmbeddingMaxTokens": {
              "type": "int",
              "defaultValue": 8091
            },
            "aiIndexName": {
              "type": "string"
            },
            "foundryChatDeployment": {
              "type": "string"
            },
            "foundryEmbeddingModel": {
              "type": "string"
            },
            "foundryEmbeddingDeployment": {
              "type": "string"
            },
            "foundryAgentId": {
              "type": "string"
            },
            "cosmosDbName": {
              "type": "string"
            },
            "cosmosContainerName": {
              "type": "string"
            },
            "appInsightsConnectionString": {
              "type": "string"
            },
            "appInsightsInstrumentationKey": {
              "type": "string"
            }
          },
          "variables": {
            "copy": [
              {
                "name": "normalizedFunctionValuesBase",
                "count": "[length(parameters('functionValues'))]",
                "input": {
                  "name": "[toLower(parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].name)]",
                  "tag": "[parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].tag]",
                  "serviceName": "[if(empty(coalesce(parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].serviceName, '')), toLower(parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].name), coalesce(parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].serviceName, toLower(parameters('functionValues')[copyIndex('normalizedFunctionValuesBase')].name)))]"
                }
              },
              {
                "name": "normalizedFunctionValues",
                "count": "[length(variables('normalizedFunctionValuesBase'))]",
                "input": "[union(variables('normalizedFunctionValuesBase')[copyIndex('normalizedFunctionValues')], createObject('hasIngress', contains(variables('ingressConfiguration'), variables('normalizedFunctionValuesBase')[copyIndex('normalizedFunctionValues')].serviceName)))]"
              }
            ],
            "$fxv#0": {
              "AZURE_AISEARCH_ENDPOINT": "AZURE_AISEARCH_ENDPOINT",
              "AZURE_AISEARCH_INCLUDE_GENERAL_INDEX": "AZURE_AISEARCH_INCLUDE_GENERAL_INDEX",
              "AZURE_AISEARCH_INDEX_NAME": "AZURE_AISEARCH_INDEX_NAME",
              "AZURE_FOUNDRY_PROJECT_ENDPOINT": "AZURE_FOUNDRY_PROJECT_ENDPOINT",
              "AZURE_FOUNDRY_AGENT_ID": "AZURE_FOUNDRY_AGENT_ID",
              "AZURE_FOUNDRY_INFERENCE_ENDPOINT": "AZURE_FOUNDRY_INFERENCE_ENDPOINT",
              "AZURE_FOUNDRY_CHAT_DEPLOYMENT": "AZURE_FOUNDRY_CHAT_DEPLOYMENT",
              "AZURE_FOUNDRY_EMBEDDING_DEPLOYMENT": "AZURE_FOUNDRY_EMBEDDING_DEPLOYMENT",
              "AZURE_FOUNDRY_EMBEDDING_MAXTOKENS": "AZURE_FOUNDRY_EMBEDDING_MAXTOKENS",
              "AZURE_FOUNDRY_EMBEDDING_MODEL": "AZURE_FOUNDRY_EMBEDDING_MODEL",
              "COSMOS_ACCOUNT_ENDPOINT": "COSMOS_ACCOUNT_ENDPOINT",
              "COSMOS_DB_NAME": "COSMOS_DB_NAME",
              "COSMOS_CONTAINER_NAME": "COSMOS_CONTAINER_NAME",
              "DOCUMENT_INTELLIGENCE_ENDPOINT": "DOCUMENT_INTELLIGENCE_ENDPOINT",
              "DOCUMENT_INTELLIGENCE_ENDPOINTS": "DOCUMENT_INTELLIGENCE_ENDPOINTS",
              "DOCUMENT_INTELLIGENCE_MODEL_NAME": "DOCUMENT_INTELLIGENCE_MODEL_NAME",
              "SERVICEBUS_CONNECTION": "SERVICEBUS_CONNECTION",
              "SERVICEBUS_CUSTOMFIELD_QUEUE_NAME": "SERVICEBUS_CUSTOMFIELD_QUEUE_NAME",
              "SERVICEBUS_DOC_QUEUE_NAME": "SERVICEBUS_DOC_QUEUE_NAME",
              "SERVICEBUS_MOVE_QUEUE_NAME": "SERVICEBUS_MOVE_QUEUE_NAME",
              "SERVICEBUS_NAMESPACE_NAME": "SERVICEBUS_NAMESPACE_NAME",
              "SERVICEBUS_TOINDEX_QUEUE_NAME": "SERVICEBUS_TOINDEX_QUEUE_NAME",
              "STORAGE_ACCOUNT_NAME": "STORAGE_ACCOUNT_NAME",
              "STORAGE_COMPLETED_CONTAINER_NAME": "STORAGE_COMPLETED_CONTAINER_NAME",
              "STORAGE_PROCESS_RESULTS_CONTAINER_NAME": "STORAGE_PROCESS_RESULTS_CONTAINER_NAME",
              "STORAGE_SOURCE_CONTAINER_NAME": "STORAGE_SOURCE_CONTAINER_NAME"
            },
            "configKeys": "[variables('$fxv#0')]",
            "ingressConfiguration": {
              "askquestions-app": {
                "external": true,
                "targetPort": 8080,
                "transport": "auto",
                "allowInsecure": false,
                "traffic": [
                  {
                    "latestRevision": true,
                    "weight": 100
                  }
                ]
              },
              "queueing-app": {
                "external": true,
                "targetPort": 8080,
                "transport": "auto",
                "allowInsecure": false,
                "traffic": [
                  {
                    "latestRevision": true,
                    "weight": 100
                  }
                ]
              }
            },
            "sharedConfiguration": [
              {
                "name": "[variables('configKeys').COSMOS_ACCOUNT_ENDPOINT]",
                "value": "[parameters('cosmosDbEndpoint')]"
              },
              {
                "name": "[variables('configKeys').COSMOS_DB_NAME]",
                "value": "[parameters('cosmosDbName')]"
              },
              {
                "name": "[variables('configKeys').COSMOS_CONTAINER_NAME]",
                "value": "[parameters('cosmosContainerName')]"
              },
              {
                "name": "[variables('configKeys').STORAGE_ACCOUNT_NAME]",
                "value": "[parameters('formStorageAcctName')]"
              },
              {
                "name": "[variables('configKeys').STORAGE_SOURCE_CONTAINER_NAME]",
                "value": "[parameters('documentStorageContainer')]"
              },
              {
                "name": "[variables('configKeys').STORAGE_PROCESS_RESULTS_CONTAINER_NAME]",
                "value": "[parameters('processResultsContainer')]"
              },
              {
                "name": "[variables('configKeys').STORAGE_COMPLETED_CONTAINER_NAME]",
                "value": "[parameters('completedContainer')]"
              },
              {
                "name": "[variables('configKeys').SERVICEBUS_NAMESPACE_NAME]",
                "value": "[parameters('serviceBusNs')]"
              },
              {
                "name": "[variables('configKeys').SERVICEBUS_DOC_QUEUE_NAME]",
                "value": "[parameters('docQueueName')]"
              },
              {
                "name": "[variables('configKeys').SERVICEBUS_CUSTOMFIELD_QUEUE_NAME]",
                "value": "[parameters('customFieldQueueName')]"
              },
              {
                "name": "[variables('configKeys').SERVICEBUS_TOINDEX_QUEUE_NAME]",
                "value": "[parameters('toIndexQueueName')]"
              },
              {
                "name": "[variables('configKeys').SERVICEBUS_MOVE_QUEUE_NAME]",
                "value": "[parameters('moveQueueName')]"
              },
              {
                "name": "[variables('configKeys').AZURE_AISEARCH_ENDPOINT]",
                "value": "[parameters('aiSearchEndpoint')]"
              },
              {
                "name": "[variables('configKeys').AZURE_AISEARCH_INDEX_NAME]",
                "value": "[parameters('aiIndexName')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_PROJECT_ENDPOINT]",
                "value": "[parameters('foundryProjectEndpoint')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_INFERENCE_ENDPOINT]",
                "value": "[parameters('foundryInferenceEndpoint')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_CHAT_DEPLOYMENT]",
                "value": "[parameters('foundryChatDeployment')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_EMBEDDING_DEPLOYMENT]",
                "value": "[parameters('foundryEmbeddingDeployment')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_EMBEDDING_MODEL]",
                "value": "[parameters('foundryEmbeddingModel')]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_EMBEDDING_MAXTOKENS]",
                "value": "[string(parameters('foundryEmbeddingMaxTokens'))]"
              },
              {
                "name": "[variables('configKeys').AZURE_FOUNDRY_AGENT_ID]",
                "value": "[parameters('foundryAgentId')]"
              },
              {
                "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_MODEL_NAME]",
                "value": "prebuilt-layout"
              },
              {
                "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_ENDPOINT]",
                "value": "[parameters('documentIntelligenceEndpoint')]"
              },
              {
                "name": "[variables('configKeys').DOCUMENT_INTELLIGENCE_ENDPOINTS]",
                "value": "[parameters('documentIntelligenceEndpoints')]"
              }
            ],
            "containerRuntimeConfiguration": "[concat(variables('sharedConfiguration'), createArray(createObject('name', format('{0}__fullyQualifiedNamespace', variables('configKeys').SERVICEBUS_CONNECTION), 'value', parameters('serviceBusFullyQualifiedNamespace')), createObject('name', format('{0}__credential', variables('configKeys').SERVICEBUS_CONNECTION), 'value', 'ManagedIdentity'), createObject('name', format('{0}__clientId', variables('configKeys').SERVICEBUS_CONNECTION), 'value', parameters('managedIdentityClientId')), createObject('name', 'MANAGED_IDENTITY_CLIENT_ID', 'value', parameters('managedIdentityClientId')), createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', parameters('appInsightsConnectionString')), createObject('name', 'APPINSIGHTS_INSTRUMENTATIONKEY', 'value', parameters('appInsightsInstrumentationKey'))))]"
          },
          "resources": {
            "containerApps": {
              "copy": {
                "name": "containerApps",
                "count": "[length(variables('normalizedFunctionValues'))]"
              },
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2023-05-01",
              "name": "[variables('normalizedFunctionValues')[copyIndex()].name]",
              "location": "[parameters('location')]",
              "tags": {
                "azd-service-name": "[variables('normalizedFunctionValues')[copyIndex()].serviceName]",
                "workload-role": "[variables('normalizedFunctionValues')[copyIndex()].tag]"
              },
              "identity": {
                "type": "SystemAssigned, UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('managedEnvironmentId')]",
                "configuration": "[union(createObject('secrets', createArray(), 'registries', createArray(createObject('server', parameters('containerRegistryServer'), 'identity', parameters('containerRegistryIdentityResourceId')))), if(variables('normalizedFunctionValues')[copyIndex()].hasIngress, createObject('ingress', variables('ingressConfiguration')[variables('normalizedFunctionValues')[copyIndex()].serviceName]), createObject()))]",
                "template": {
                  "containers": [
                    {
                      "name": "[variables('normalizedFunctionValues')[copyIndex()].serviceName]",
                      "image": "[format('{0}/{1}:latest', parameters('containerRegistryServer'), variables('normalizedFunctionValues')[copyIndex()].serviceName)]",
                      "env": "[variables('containerRuntimeConfiguration')]",
                      "resources": {
                        "cpu": "[if(variables('normalizedFunctionValues')[copyIndex()].hasIngress, json('1.0'), json('0.5'))]",
                        "memory": "[if(variables('normalizedFunctionValues')[copyIndex()].hasIngress, '2Gi', '1Gi')]"
                      }
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": "[if(variables('normalizedFunctionValues')[copyIndex()].hasIngress, 3, 2)]"
                  }
                }
              }
            }
          },
          "outputs": {
            "systemAssignedIdentities": {
              "type": "array",
              "copy": {
                "count": "[length(variables('normalizedFunctionValues'))]",
                "input": "[reference(format('containerApps[{0}]', copyIndex()), '2023-05-01', 'full').identity.principalId]"
              }
            },
            "services": {
              "type": "array",
              "copy": {
                "count": "[length(variables('normalizedFunctionValues'))]",
                "input": {
                  "serviceName": "[variables('normalizedFunctionValues')[copyIndex()].serviceName]",
                  "containerAppName": "[variables('normalizedFunctionValues')[copyIndex()].name]",
                  "containerAppResourceId": "[resourceId('Microsoft.App/containerApps', variables('normalizedFunctionValues')[copyIndex()].name)]",
                  "ingressFqdn": "[if(variables('normalizedFunctionValues')[copyIndex()].hasIngress, reference(resourceId('Microsoft.App/containerApps', variables('normalizedFunctionValues')[copyIndex()].name), '2023-05-01', 'full').properties.configuration.ingress.fqdn, '')]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "aiSearch",
        "appInsights",
        "containerEnvironment",
        "containerRegistry",
        "cosmosDb",
        "docIntelligenceService",
        "foundry",
        "managedIdentity",
        "managedIdentityAcrPull",
        "rg",
        "servicebus",
        "storage"
      ]
    },
    "roleAssigments": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "roleAssigments",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "docIntelligencePrincipalIds": {
            "value": "[reference('docIntelligenceService').outputs.docIntelligencePrincipalIds.value]"
          },
          "userAssignedManagedIdentityPrincipalId": {
            "value": "[reference('managedIdentity').outputs.principalId.value]"
          },
          "currentUserObjectId": {
            "value": "[parameters('currentUserObjectId')]"
          },
          "functionPrincipalIds": {
            "value": "[reference('functions').outputs.systemAssignedIdentities.value]"
          },
          "containerRegistryName": {
            "value": "[reference('containerRegistry').outputs.name.value]"
          },
          "cosmosAccountName": {
            "value": "[reference('cosmosDb').outputs.cosmosDbAccountName.value]"
          },
          "cosmosAccountResourceGroup": {
            "value": "[variables('resourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "8881880763875641122"
            }
          },
          "parameters": {
            "docIntelligencePrincipalIds": {
              "type": "array"
            },
            "functionPrincipalIds": {
              "type": "array"
            },
            "userAssignedManagedIdentityPrincipalId": {
              "type": "string"
            },
            "currentUserObjectId": {
              "type": "string"
            },
            "containerRegistryName": {
              "type": "string"
            },
            "cosmosAccountName": {
              "type": "string"
            },
            "cosmosAccountResourceGroup": {
              "type": "string"
            }
          },
          "variables": {
            "$fxv#0": {
              "contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
              "owner": "8e3af657-a8ff-443c-a75c-2fe8c4bcb635",
              "reader": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
              "rbacAdministrator": "f58310d9-a9f6-439a-9e8d-f62e7b41a168",
              "userAccessAdministrator": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
              "keyVaultAdministrator": "00482a5a-887f-4fb3-b363-3b7fe8e74483",
              "keyVaultContributor": "f25e0fa2-a7c8-4377-a976-54943a77a395",
              "keyVaultSecretsOfficer": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6",
              "acrPull": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
              "acrPush": "8311e382-0749-4cb8-b61a-304f252e45ec",
              "serviceBusDataOwner": "090c5cfd-751d-490a-894a-3ce6f1109419",
              "serviceBusDataReceiver": "4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0",
              "serviceBusDataSender": "69a216fc-b8fb-44d8-bc22-1f3c2cd27a39",
              "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "storageBlobDataOwner": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b",
              "storageBlobDataReader": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "storageQueueDataContributor": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
              "storageQueueDataReader": "19e7f393-937e-4f77-808e-94535e297925",
              "storageTableDataContributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
              "storageTableDataReader": "76199698-9eea-4c19-bc75-cec21354c6b6",
              "cognitiveServicesUser": "5e0bd9bd-7b93-4f28-af87-19fc36ad61bd",
              "cosmosDbOperator": "230815da-be43-4aae-9cb4-875f7bd000aa",
              "cosmosDbBuiltInDataContributor": "5bd9cd88-fe45-4216-938b-f97437e15450",
              "cosmosDbAccountReader": "fbdf93bf-df7d-467e-a4d2-9458aa1360c8",
              "searchServiceContributor": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
              "searchIndexDataContributor": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
              "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f"
            },
            "principalIds": "[if(not(empty(parameters('currentUserObjectId'))), concat(parameters('functionPrincipalIds'), createArray(parameters('currentUserObjectId'), parameters('userAssignedManagedIdentityPrincipalId'))), concat(parameters('functionPrincipalIds'), createArray(parameters('userAssignedManagedIdentityPrincipalId'))))]",
            "acrPrincipalIds": "[if(not(empty(parameters('currentUserObjectId'))), concat(parameters('functionPrincipalIds'), createArray(parameters('currentUserObjectId'))), parameters('functionPrincipalIds'))]",
            "deploymentEntropy": "3F2504E0-4F89-11D3-9A0C-0305E82C3302",
            "roles": "[variables('$fxv#0')]"
          },
          "resources": [
            {
              "copy": {
                "name": "docIntelligenceBlobDataReader",
                "count": "[length(parameters('docIntelligencePrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(parameters('docIntelligencePrincipalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataReader), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataReader)]",
                "principalId": "[parameters('docIntelligencePrincipalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityBlobDataContrib",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityBlobDataOwner",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataOwner), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataOwner)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityServiceBusDataOwner",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').serviceBusDataOwner), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').serviceBusDataOwner)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityStorageQueueDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageQueueDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityStorageTableDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageTableDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityKeyVaultSecretUser",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentitySearchServiceContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchServiceContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchServiceContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityCognitiveServicesUser",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cognitiveServicesUser)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentitySearchIndexDataReader",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataReader), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataReader)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentitySearchIndexDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityCosmosDataContributor",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbBuiltInDataContributor), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbBuiltInDataContributor)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityComsmosDbOperator",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbOperator), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbOperator)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "functionManagedIdentityComsmosDbAccountReader",
                "count": "[length(variables('principalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(variables('principalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbAccountReader), variables('deploymentEntropy'))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').cosmosDbAccountReader)]",
                "principalId": "[variables('principalIds')[copyIndex()]]"
              }
            },
            {
              "copy": {
                "name": "principalAcrPullAssignments",
                "count": "[length(variables('acrPrincipalIds'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('containerRegistryName'))]",
              "name": "[guid(variables('acrPrincipalIds')[copyIndex()], resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPull), resourceId('Microsoft.ContainerRegistry/registries', parameters('containerRegistryName')))]",
              "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPull)]",
                "principalId": "[variables('acrPrincipalIds')[copyIndex()]]"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "cosmos-dataplane-roleassignments",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "principalIds": {
                    "value": "[variables('principalIds')]"
                  },
                  "accountName": {
                    "value": "[parameters('cosmosAccountName')]"
                  },
                  "cosmosRg": {
                    "value": "[parameters('cosmosAccountResourceGroup')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.34.44.8038",
                      "templateHash": "3970616830610173399"
                    }
                  },
                  "parameters": {
                    "accountName": {
                      "type": "string",
                      "metadata": {
                        "description": "Cosmos DB account name"
                      }
                    },
                    "principalIds": {
                      "type": "array",
                      "metadata": {
                        "description": "AAD objectId of the principal to grant data access (user, SPN, or managed identity)"
                      }
                    },
                    "cosmosRg": {
                      "type": "string",
                      "metadata": {
                        "description": "Resource group of the Cosmos account"
                      }
                    }
                  },
                  "variables": {
                    "subscriptionId": "[subscription().subscriptionId]",
                    "cosmosDataRoles": {
                      "reader": "00000000-0000-0000-0000-000000000001",
                      "contributor": "00000000-0000-0000-0000-000000000002"
                    }
                  },
                  "resources": [
                    {
                      "copy": {
                        "name": "dataContributorAtAccount",
                        "count": "[length(parameters('principalIds'))]"
                      },
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2024-05-15",
                      "name": "[format('{0}/{1}', parameters('accountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), parameters('principalIds')[copyIndex()], 'account-scope-contributor'))]",
                      "properties": {
                        "roleDefinitionId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/sqlRoleDefinitions/{3}', variables('subscriptionId'), parameters('cosmosRg'), parameters('accountName'), variables('cosmosDataRoles').contributor)]",
                        "principalId": "[parameters('principalIds')[copyIndex()]]",
                        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
                      }
                    },
                    {
                      "copy": {
                        "name": "dataReaderAtAccount",
                        "count": "[length(parameters('principalIds'))]"
                      },
                      "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
                      "apiVersion": "2024-05-15",
                      "name": "[format('{0}/{1}', parameters('accountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), parameters('principalIds')[copyIndex()], 'account-scope-reader'))]",
                      "properties": {
                        "roleDefinitionId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.DocumentDB/databaseAccounts/{2}/sqlRoleDefinitions/{3}', variables('subscriptionId'), parameters('cosmosRg'), parameters('accountName'), variables('cosmosDataRoles').reader)]",
                        "principalId": "[parameters('principalIds')[copyIndex()]]",
                        "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
                      }
                    }
                  ]
                }
              }
            }
          ],
          "outputs": {
            "principalIds": {
              "type": "array",
              "value": "[variables('principalIds')]"
            }
          }
        }
      },
      "dependsOn": [
        "containerRegistry",
        "cosmosDb",
        "docIntelligenceService",
        "functions",
        "managedIdentity",
        "rg"
      ]
    },
    "aiSearch": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "aiSearch",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiSearchName": {
            "value": "[variables('aiSearchName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.34.44.8038",
              "templateHash": "12164776842200732067"
            }
          },
          "parameters": {
            "aiSearchName": {
              "type": "string"
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2023-11-01",
              "name": "[parameters('aiSearchName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "basic"
              }
            }
          ],
          "outputs": {
            "aiSearchEndpoint": {
              "type": "string",
              "value": "[format('https://{0}.search.windows.net', parameters('aiSearchName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "rg"
      ]
    }
  },
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[variables('resourceGroupName')]"
    },
    "foundryAccountName": {
      "type": "string",
      "value": "[reference('foundry').outputs.accountName.value]"
    },
    "foundryProjectEndpoint": {
      "type": "string",
      "value": "[reference('foundry').outputs.projectEndpoint.value]"
    },
    "foundryInferenceEndpoint": {
      "type": "string",
      "value": "[reference('foundry').outputs.inferenceEndpoint.value]"
    },
    "foundryChatDeployment": {
      "type": "string",
      "value": "[reference('foundry').outputs.chatDeploymentName.value]"
    },
    "foundryEmbeddingDeployment": {
      "type": "string",
      "value": "[reference('foundry').outputs.embeddingDeploymentName.value]"
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "value": "[reference('containerEnvironment').outputs.name.value]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference('containerRegistry').outputs.loginServer.value]"
    },
    "services": {
      "type": "array",
      "value": "[reference('functions').outputs.services.value]"
    },
    "AZURE_CONTAINER_REGISTRY_ENDPOINT": {
      "type": "string",
      "value": "[reference('containerRegistry').outputs.loginServer.value]"
    }
  }
}